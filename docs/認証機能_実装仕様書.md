# èªè¨¼æ©Ÿèƒ½ å®Ÿè£…ä»•æ§˜æ›¸

## ğŸ“… å®Ÿè£…æ—¥ï¼š2026å¹´1æœˆ16æ—¥

---

## ğŸ¯ æœ¬æ—¥ã®å®Ÿè£…ç›®æ¨™

### èªè¨¼ã¾ã‚ã‚Š
1. âœ… adminã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆç”¨ã‚³ãƒãƒ³ãƒ‰ã®ä½œæˆ
2. âœ… ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
3. âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
4. âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ä½œæˆæ©Ÿèƒ½ï¼ˆæ¨©é™ã‚’é¸ã¹ã‚‹ï¼‰
5. âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã‚‹ï¼ˆAmazon SESï¼‰
6. âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹
7. âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
8. âœ… è‡ªèº«ã®æ¨©é™ãŒã‚ã‚‹ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
9. âœ… å‚åŠ è€…ã¨å‡ºå“è€…ã®æ¨©é™ãŒã‚ã‚‹å ´åˆã¯ç”»é¢åˆ‡ã‚Šæ›¿ãˆ

---

## ğŸ“ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### èªè¨¼ãƒ•ãƒ­ãƒ¼

```
[ç®¡ç†è€…] â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ â†’ [ãƒ¡ãƒ¼ãƒ«é€ä¿¡] â†’ [ãƒ¦ãƒ¼ã‚¶ãƒ¼] â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š â†’ ãƒ­ã‚°ã‚¤ãƒ³ â†’ æ¨©é™ã«å¿œã˜ãŸç”»é¢è¡¨ç¤º
```

### ãƒ­ãƒ¼ãƒ«åˆ¥ç”»é¢

```
admin â†’ ç®¡ç†ç”»é¢ï¼ˆ/admin/*ï¼‰
seller â†’ å‡ºå“è€…ç®¡ç†ç”»é¢ï¼ˆ/seller/*ï¼‰
participant â†’ å‚åŠ è€…ç”»é¢ï¼ˆ/ï¼‰

seller + participant â†’ ãƒ­ã‚´ã‚¯ãƒªãƒƒã‚¯ã§ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
```

---

## ğŸ—„ï¸ ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆv2.2ï¼‰

### 1. users
- id, name, email, password
- status (pending/approved/suspended/rejected)
- email_verified_at

### 2. roles
- id, name (admin/seller/participant)

### 3. user_roles
- user_id, role_id

### 4. password_reset_tokens
- email, token, created_at

### 5. email_verification_tokensï¼ˆæ–°è¦è¿½åŠ ï¼‰
- user_id, token, expires_at

---

## ğŸ“‹ å®Ÿè£…æ‰‹é †

---

## 1. adminã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆç”¨ã‚³ãƒãƒ³ãƒ‰

### ã‚³ãƒãƒ³ãƒ‰ä»•æ§˜

**ã‚³ãƒãƒ³ãƒ‰å**: `app:create-admin`

**å®Ÿè¡Œæ–¹æ³•**:
```bash
php artisan app:create-admin
```

**å¯¾è©±å½¢å¼**:
```
ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™
åå‰: ç”°ä¸­å¤ªéƒ
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: admin@example.com
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ********
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰: ********

âœ“ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ
  åå‰: ç”°ä¸­å¤ªéƒ
  ãƒ¡ãƒ¼ãƒ«: admin@example.com
  ãƒ­ãƒ¼ãƒ«: admin
```

### å®Ÿè£…

```php
// app/Console/Commands/CreateAdminCommand.php
<?php

namespace App\Console\Commands;

use App\Models\User;
use App\Models\Role;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Validator;

class CreateAdminCommand extends Command
{
    protected $signature = 'app:create-admin';
    protected $description = 'ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™';

    public function handle()
    {
        $this->info('ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™');
        $this->newLine();

        // å…¥åŠ›
        $name = $this->ask('åå‰');
        $email = $this->ask('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');
        $password = $this->secret('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰');
        $passwordConfirmation = $this->secret('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰');

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        $validator = Validator::make([
            'name' => $name,
            'email' => $email,
            'password' => $password,
            'password_confirmation' => $passwordConfirmation,
        ], [
            'name' => 'required|string|max:255',
            'email' => 'required|email|unique:users,email',
            'password' => 'required|string|min:8|confirmed',
        ]);

        if ($validator->fails()) {
            $this->error('å…¥åŠ›ã‚¨ãƒ©ãƒ¼:');
            foreach ($validator->errors()->all() as $error) {
                $this->error('  ' . $error);
            }
            return 1;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        $user = User::create([
            'name' => $name,
            'email' => $email,
            'password' => Hash::make($password),
            'status' => 'approved',
            'approved_at' => now(),
            'email_verified_at' => now(),
            'is_active' => true,
        ]);

        // admin ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
        $adminRole = Role::where('name', 'admin')->firstOrFail();
        $user->roles()->attach($adminRole->id, [
            'assigned_at' => now(),
        ]);

        $this->newLine();
        $this->info('âœ“ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
        $this->table(
            ['é …ç›®', 'å€¤'],
            [
                ['åå‰', $user->name],
                ['ãƒ¡ãƒ¼ãƒ«', $user->email],
                ['ãƒ­ãƒ¼ãƒ«', 'admin'],
                ['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', $user->status],
            ]
        );

        return 0;
    }
}
```

---

## 2. email_verification_tokens ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```php
// database/migrations/2024_01_16_300001_create_email_verification_tokens_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('email_verification_tokens', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')
                ->constrained('users')
                ->onDelete('cascade')
                ->comment('ãƒ¦ãƒ¼ã‚¶ãƒ¼ID');
            $table->string('token', 64)->unique()->comment('æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³');
            $table->timestamp('expires_at')->comment('æœ‰åŠ¹æœŸé™');
            $table->timestamp('verified_at')->nullable()->comment('æ¤œè¨¼å®Œäº†æ—¥æ™‚');
            $table->timestamps();
            
            $table->index('token');
            $table->index(['user_id', 'expires_at']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('email_verification_tokens');
    }
};
```

---

## 3. ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½

### APIä»•æ§˜

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/auth/login`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "name": "ç”°ä¸­å¤ªéƒ",
      "email": "user@example.com",
      "status": "approved",
      "roles": [
        {
          "id": 2,
          "name": "seller",
          "display_name": "å‡ºå“è€…"
        },
        {
          "id": 3,
          "name": "participant",
          "display_name": "å‚åŠ è€…"
        }
      ]
    },
    "token": "1|aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890"
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰**:
```json
{
  "success": false,
  "message": "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
}
```

### å®Ÿè£…

```php
// app/Http/Controllers/Auth/LoginController.php
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\ValidationException;

class LoginController extends Controller
{
    public function login(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'password' => 'required|string',
        ]);

        $user = User::where('email', $request->email)->first();

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„
        if (!$user || !Hash::check($request->password, $user->password)) {
            throw ValidationException::withMessages([
                'email' => ['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'],
            ]);
        }

        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        if ($user->status !== 'approved') {
            throw ValidationException::withMessages([
                'email' => ['ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' . $user->status . 'ï¼‰'],
            ]);
        }

        if (!$user->is_active) {
            throw ValidationException::withMessages([
                'email' => ['ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™'],
            ]);
        }

        // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°
        $user->update(['last_login_at' => now()]);

        // ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
        $token = $user->createToken('auth-token')->plainTextToken;

        return response()->json([
            'success' => true,
            'data' => [
                'user' => [
                    'id' => $user->id,
                    'name' => $user->name,
                    'email' => $user->email,
                    'status' => $user->status,
                    'roles' => $user->roles()->get(['id', 'name', 'display_name']),
                ],
                'token' => $token,
            ],
        ]);
    }

    public function logout(Request $request)
    {
        $request->user()->currentAccessToken()->delete();

        return response()->json([
            'success' => true,
            'message' => 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
        ]);
    }

    public function me(Request $request)
    {
        $user = $request->user();

        return response()->json([
            'success' => true,
            'data' => [
                'user' => [
                    'id' => $user->id,
                    'name' => $user->name,
                    'email' => $user->email,
                    'status' => $user->status,
                    'roles' => $user->roles()->get(['id', 'name', 'display_name']),
                    'seller_profile' => $user->sellerProfile,
                ],
            ],
        ]);
    }
}
```

---

## 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ä½œæˆæ©Ÿèƒ½ï¼ˆç®¡ç†è€…ç”¨ï¼‰

### APIä»•æ§˜

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/admin/users`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "name": "ä½è—¤èŠ±å­",
  "email": "sato@example.com",
  "phone": "090-1234-5678",
  "roles": ["seller", "participant"]
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 2,
      "name": "ä½è—¤èŠ±å­",
      "email": "sato@example.com",
      "status": "pending",
      "roles": ["seller", "participant"]
    },
    "verification_url": "https://auction.example.com/auth/set-password?token=abc123..."
  },
  "message": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ"
}
```

### å®Ÿè£…

```php
// app/Http/Controllers/Admin/UserController.php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use App\Models\Role;
use App\Models\EmailVerificationToken;
use App\Mail\SetPasswordMail;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Str;

class UserController extends Controller
{
    public function store(Request $request)
    {
        $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|email|unique:users,email',
            'phone' => 'nullable|string|max:20',
            'postal_code' => 'nullable|string|max:10',
            'prefecture' => 'nullable|string|max:50',
            'city' => 'nullable|string|max:100',
            'address_line1' => 'nullable|string|max:255',
            'address_line2' => 'nullable|string|max:255',
            'roles' => 'required|array|min:1',
            'roles.*' => 'required|string|in:admin,seller,participant',
        ]);

        DB::beginTransaction();
        try {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
            $user = User::create([
                'name' => $request->name,
                'email' => $request->email,
                'password' => Hash::make(Str::random(32)), // ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                'phone' => $request->phone,
                'postal_code' => $request->postal_code,
                'prefecture' => $request->prefecture,
                'city' => $request->city,
                'address_line1' => $request->address_line1,
                'address_line2' => $request->address_line2,
                'status' => 'pending',
                'is_active' => true,
            ]);

            // ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
            foreach ($request->roles as $roleName) {
                $role = Role::where('name', $roleName)->firstOrFail();
                $user->roles()->attach($role->id, [
                    'assigned_at' => now(),
                    'assigned_by' => auth()->id(),
                ]);
            }

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            $token = Str::random(64);
            EmailVerificationToken::create([
                'user_id' => $user->id,
                'token' => $token,
                'expires_at' => now()->addDays(7), // 7æ—¥é–“æœ‰åŠ¹
            ]);

            // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            $verificationUrl = config('app.frontend_url') . '/auth/set-password?token=' . $token;
            Mail::to($user->email)->send(new SetPasswordMail($user, $verificationUrl));

            DB::commit();

            return response()->json([
                'success' => true,
                'data' => [
                    'user' => [
                        'id' => $user->id,
                        'name' => $user->name,
                        'email' => $user->email,
                        'status' => $user->status,
                        'roles' => $request->roles,
                    ],
                    'verification_url' => $verificationUrl,
                ],
                'message' => 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
            ], 201);

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }

    public function index(Request $request)
    {
        $query = User::with('roles');

        // ãƒ•ã‚£ãƒ«ã‚¿
        if ($request->has('status')) {
            $query->where('status', $request->status);
        }

        if ($request->has('role')) {
            $query->whereHas('roles', function ($q) use ($request) {
                $q->where('name', $request->role);
            });
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
        $users = $query->latest()->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $users,
        ]);
    }

    public function show($id)
    {
        $user = User::with(['roles', 'sellerProfile'])->findOrFail($id);

        return response()->json([
            'success' => true,
            'data' => ['user' => $user],
        ]);
    }

    public function update(Request $request, $id)
    {
        $user = User::findOrFail($id);

        $request->validate([
            'name' => 'string|max:255',
            'phone' => 'nullable|string|max:20',
            'status' => 'in:pending,approved,suspended,rejected',
            'roles' => 'array',
            'roles.*' => 'string|in:admin,seller,participant',
        ]);

        DB::beginTransaction();
        try {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
            $user->update($request->only([
                'name', 'phone', 'postal_code', 'prefecture',
                'city', 'address_line1', 'address_line2', 'status'
            ]));

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†
            if ($request->has('status')) {
                if ($request->status === 'approved' && $user->status !== 'approved') {
                    $user->update([
                        'approved_at' => now(),
                        'approved_by' => auth()->id(),
                    ]);
                }
            }

            // ãƒ­ãƒ¼ãƒ«æ›´æ–°
            if ($request->has('roles')) {
                $user->roles()->detach();
                foreach ($request->roles as $roleName) {
                    $role = Role::where('name', $roleName)->firstOrFail();
                    $user->roles()->attach($role->id, [
                        'assigned_at' => now(),
                        'assigned_by' => auth()->id(),
                    ]);
                }
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'data' => ['user' => $user->fresh(['roles'])],
                'message' => 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }
}
```

---

## 5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ©Ÿèƒ½

### APIä»•æ§˜

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/auth/set-password`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "token": "abc123...",
  "password": "newpassword123",
  "password_confirmation": "newpassword123"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "success": true,
  "message": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚"
}
```

### å®Ÿè£…

```php
// app/Http/Controllers/Auth/SetPasswordController.php
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\EmailVerificationToken;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\DB;

class SetPasswordController extends Controller
{
    public function verify(Request $request)
    {
        $request->validate([
            'token' => 'required|string',
        ]);

        $verificationToken = EmailVerificationToken::where('token', $request->token)
            ->where('expires_at', '>', now())
            ->whereNull('verified_at')
            ->with('user')
            ->first();

        if (!$verificationToken) {
            return response()->json([
                'success' => false,
                'message' => 'ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™',
            ], 400);
        }

        return response()->json([
            'success' => true,
            'data' => [
                'user' => [
                    'name' => $verificationToken->user->name,
                    'email' => $verificationToken->user->email,
                ],
            ],
        ]);
    }

    public function setPassword(Request $request)
    {
        $request->validate([
            'token' => 'required|string',
            'password' => 'required|string|min:8|confirmed',
        ]);

        $verificationToken = EmailVerificationToken::where('token', $request->token)
            ->where('expires_at', '>', now())
            ->whereNull('verified_at')
            ->with('user')
            ->first();

        if (!$verificationToken) {
            return response()->json([
                'success' => false,
                'message' => 'ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™',
            ], 400);
        }

        DB::beginTransaction();
        try {
            $user = $verificationToken->user;

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
            $user->update([
                'password' => Hash::make($request->password),
                'email_verified_at' => now(),
            ]);

            // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼æ¸ˆã¿ã«ã™ã‚‹
            $verificationToken->update([
                'verified_at' => now(),
            ]);

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }
}
```

---

## 6. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½

### APIä»•æ§˜

#### 6.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”³è«‹

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/auth/forgot-password`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "email": "user@example.com"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "message": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ"
}
```

#### 6.2 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/auth/reset-password`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "email": "user@example.com",
  "token": "reset-token-here",
  "password": "newpassword123",
  "password_confirmation": "newpassword123"
}
```

### å®Ÿè£…

```php
// app/Http/Controllers/Auth/PasswordResetController.php
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use App\Mail\PasswordResetMail;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Password;

class PasswordResetController extends Controller
{
    public function forgot(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
        ]);

        $user = User::where('email', $request->email)->first();

        if (!$user) {
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªãã¦ã‚‚æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
            return response()->json([
                'success' => true,
                'message' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
            ]);
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
        $token = Password::createToken($user);

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        $resetUrl = config('app.frontend_url') . '/auth/reset-password?token=' . $token . '&email=' . urlencode($user->email);
        Mail::to($user->email)->send(new PasswordResetMail($user, $resetUrl));

        return response()->json([
            'success' => true,
            'message' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ',
        ]);
    }

    public function reset(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'token' => 'required|string',
            'password' => 'required|string|min:8|confirmed',
        ]);

        $status = Password::reset(
            $request->only('email', 'password', 'password_confirmation', 'token'),
            function ($user, $password) {
                $user->forceFill([
                    'password' => Hash::make($password)
                ])->save();
            }
        );

        if ($status === Password::PASSWORD_RESET) {
            return response()->json([
                'success' => true,
                'message' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ',
            ]);
        }

        return response()->json([
            'success' => false,
            'message' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
        ], 400);
    }
}
```

---

## 7. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆAmazon SESï¼‰

### è¨­å®š

#### .env
```env
MAIL_MAILER=ses
MAIL_FROM_ADDRESS=noreply@auction.example.com
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_DEFAULT_REGION=ap-northeast-1
AWS_SES_REGION=ap-northeast-1
```

#### config/mail.php
```php
'from' => [
    'address' => env('MAIL_FROM_ADDRESS', 'noreply@auction.example.com'),
    'name' => env('MAIL_FROM_NAME', 'ãƒ¡ãƒ€ã‚«ãƒ©ã‚¤ãƒ–ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³'),
],
```

### ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãƒ¡ãƒ¼ãƒ«

```php
// app/Mail/SetPasswordMail.php
<?php

namespace App\Mail;

use App\Models\User;
use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class SetPasswordMail extends Mailable
{
    use Queueable, SerializesModels;

    public $user;
    public $verificationUrl;

    public function __construct(User $user, string $verificationUrl)
    {
        $this->user = $user;
        $this->verificationUrl = $verificationUrl;
    }

    public function build()
    {
        return $this->subject('ã€ãƒ¡ãƒ€ã‚«ãƒ©ã‚¤ãƒ–ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã®ãŠé¡˜ã„')
            ->markdown('emails.auth.set-password');
    }
}
```

```blade
{{-- resources/views/emails/auth/set-password.blade.php --}}
@component('mail::message')
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã®ãŠé¡˜ã„

{{ $user->name }} æ§˜

ãƒ¡ãƒ€ã‚«ãƒ©ã‚¤ãƒ–ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¸ã‚ˆã†ã“ãï¼

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

@component('mail::button', ['url' => $verificationUrl])
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹
@endcomponent

**ã“ã®ãƒªãƒ³ã‚¯ã¯7æ—¥é–“æœ‰åŠ¹ã§ã™ã€‚**

ã‚‚ã—ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

{{ config('app.name') }}
@endcomponent
```

#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«

```php
// app/Mail/PasswordResetMail.php
<?php

namespace App\Mail;

use App\Models\User;
use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue::SerializesModels;

class PasswordResetMail extends Mailable
{
    use Queueable, SerializesModels;

    public $user;
    public $resetUrl;

    public function __construct(User $user, string $resetUrl)
    {
        $this->user = $user;
        $this->resetUrl = $resetUrl;
    }

    public function build()
    {
        return $this->subject('ã€ãƒ¡ãƒ€ã‚«ãƒ©ã‚¤ãƒ–ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ')
            ->markdown('emails.auth.password-reset');
    }
}
```

```blade
{{-- resources/views/emails/auth/password-reset.blade.php --}}
@component('mail::message')
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ

{{ $user->name }} æ§˜

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚

ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

@component('mail::button', ['url' => $resetUrl])
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
@endcomponent

**ã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚**

ã‚‚ã—ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

{{ config('app.name') }}
@endcomponent
```

---

## 8. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 8.1 ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢

```typescript
// src/resources/ts/pages/auth/Login.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import {
  Container,
  Box,
  Card,
  CardContent,
  TextField,
  Button,
  Typography,
  Alert,
  Link,
} from '@mui/material';
import axios from 'axios';

const Login: React.FC = () => {
  const navigate = useNavigate();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      const response = await axios.post('/api/auth/login', {
        email,
        password,
      });

      const { token, user } = response.data.data;

      // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
      localStorage.setItem('auth_token', token);
      localStorage.setItem('user', JSON.stringify(user));

      // ãƒ­ãƒ¼ãƒ«ã«å¿œã˜ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      if (user.roles.some((r: any) => r.name === 'admin')) {
        navigate('/admin');
      } else if (user.roles.some((r: any) => r.name === 'seller')) {
        navigate('/seller');
      } else {
        navigate('/');
      }
    } catch (err: any) {
      setError(
        err.response?.data?.message ||
        'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ'
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <Container maxWidth="sm">
      <Box sx={{ mt: 8, mb: 4 }}>
        <Card>
          <CardContent sx={{ p: 4 }}>
            <Typography variant="h4" align="center" gutterBottom>
              ãƒ­ã‚°ã‚¤ãƒ³
            </Typography>

            {error && (
              <Alert severity="error" sx={{ mb: 2 }}>
                {error}
              </Alert>
            )}

            <form onSubmit={handleSubmit}>
              <TextField
                fullWidth
                label="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                margin="normal"
                required
              />

              <TextField
                fullWidth
                label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                margin="normal"
                required
              />

              <Button
                type="submit"
                fullWidth
                variant="contained"
                size="large"
                disabled={loading}
                sx={{ mt: 3, mb: 2 }}
              >
                {loading ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
              </Button>

              <Box sx={{ textAlign: 'center' }}>
                <Link
                  href="/auth/forgot-password"
                  variant="body2"
                >
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã®æ–¹
                </Link>
              </Box>
            </form>
          </CardContent>
        </Card>
      </Box>
    </Container>
  );
};

export default Login;
```

### 8.2 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šç”»é¢

```typescript
// src/resources/ts/pages/auth/SetPassword.tsx
import React, { useState, useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import {
  Container,
  Box,
  Card,
  CardContent,
  TextField,
  Button,
  Typography,
  Alert,
  CircularProgress,
} from '@mui/material';
import axios from 'axios';

const SetPassword: React.FC = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const token = searchParams.get('token');

  const [userName, setUserName] = useState('');
  const [password, setPassword] = useState('');
  const [passwordConfirmation, setPasswordConfirmation] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [verifying, setVerifying] = useState(true);

  useEffect(() => {
    verifyToken();
  }, []);

  const verifyToken = async () => {
    if (!token) {
      setError('ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™');
      setVerifying(false);
      return;
    }

    try {
      const response = await axios.post('/api/auth/verify-token', { token });
      setUserName(response.data.data.user.name);
    } catch (err: any) {
      setError(
        err.response?.data?.message ||
        'ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™'
      );
    } finally {
      setVerifying(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (password !== passwordConfirmation) {
      setError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
      return;
    }

    setLoading(true);

    try {
      await axios.post('/api/auth/set-password', {
        token,
        password,
        password_confirmation: passwordConfirmation,
      });

      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      navigate('/login');
    } catch (err: any) {
      setError(
        err.response?.data?.message ||
        'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ'
      );
    } finally {
      setLoading(false);
    }
  };

  if (verifying) {
    return (
      <Container maxWidth="sm">
        <Box sx={{ mt: 8, textAlign: 'center' }}>
          <CircularProgress />
          <Typography sx={{ mt: 2 }}>ç¢ºèªä¸­...</Typography>
        </Box>
      </Container>
    );
  }

  if (error && !userName) {
    return (
      <Container maxWidth="sm">
        <Box sx={{ mt: 8 }}>
          <Alert severity="error">{error}</Alert>
        </Box>
      </Container>
    );
  }

  return (
    <Container maxWidth="sm">
      <Box sx={{ mt: 8, mb: 4 }}>
        <Card>
          <CardContent sx={{ p: 4 }}>
            <Typography variant="h4" align="center" gutterBottom>
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
            </Typography>

            <Typography variant="body1" sx={{ mb: 3 }}>
              {userName} æ§˜
            </Typography>

            {error && (
              <Alert severity="error" sx={{ mb: 2 }}>
                {error}
              </Alert>
            )}

            <form onSubmit={handleSubmit}>
              <TextField
                fullWidth
                label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                margin="normal"
                required
                helperText="8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„"
              />

              <TextField
                fullWidth
                label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰"
                type="password"
                value={passwordConfirmation}
                onChange={(e) => setPasswordConfirmation(e.target.value)}
                margin="normal"
                required
              />

              <Button
                type="submit"
                fullWidth
                variant="contained"
                size="large"
                disabled={loading}
                sx={{ mt: 3 }}
              >
                {loading ? 'è¨­å®šä¸­...' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š'}
              </Button>
            </form>
          </CardContent>
        </Card>
      </Box>
    </Container>
  );
};

export default SetPassword;
```

### 8.3 ãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½

```typescript
// src/resources/ts/components/RoleSwitcher.tsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import {
  Menu,
  MenuItem,
  IconButton,
  Typography,
  Box,
} from '@mui/material';
import { SwapHoriz as SwapHorizIcon } from '@mui/icons-material';

interface Role {
  name: string;
  display_name: string;
}

interface RoleSwitcherProps {
  roles: Role[];
  currentRole: string;
}

const RoleSwitcher: React.FC<RoleSwitcherProps> = ({ roles, currentRole }) => {
  const navigate = useNavigate();
  const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);

  // seller ã¨ participant ã®ä¸¡æ–¹ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º
  const hasBothRoles = roles.some(r => r.name === 'seller') && roles.some(r => r.name === 'participant');

  if (!hasBothRoles) {
    return null;
  }

  const handleClick = (event: React.MouseEvent<HTMLElement>) => {
    setAnchorEl(event.currentTarget);
  };

  const handleClose = () => {
    setAnchorEl(null);
  };

  const handleSwitch = (roleName: string) => {
    handleClose();
    
    if (roleName === 'seller') {
      navigate('/seller');
    } else if (roleName === 'participant') {
      navigate('/');
    }
  };

  return (
    <>
      <IconButton
        onClick={handleClick}
        size="small"
        sx={{ ml: 2 }}
        aria-label="ç”»é¢åˆ‡ã‚Šæ›¿ãˆ"
      >
        <SwapHorizIcon />
      </IconButton>

      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleClose}
      >
        <MenuItem
          onClick={() => handleSwitch('participant')}
          selected={currentRole === 'participant'}
        >
          <Box>
            <Typography variant="body1">å‚åŠ è€…ç”»é¢</Typography>
            <Typography variant="caption" color="text.secondary">
              ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³å‚åŠ ãƒ»è½æœ­ç®¡ç†
            </Typography>
          </Box>
        </MenuItem>

        <MenuItem
          onClick={() => handleSwitch('seller')}
          selected={currentRole === 'seller'}
        >
          <Box>
            <Typography variant="body1">å‡ºå“è€…ç”»é¢</Typography>
            <Typography variant="caption" color="text.secondary">
              å•†å“ç®¡ç†ãƒ»å£²ä¸Šç¢ºèª
            </Typography>
          </Box>
        </MenuItem>
      </Menu>
    </>
  );
};

export default RoleSwitcher;
```

---

## 9. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š

### routes/api.php

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Auth\LoginController;
use App\Http\Controllers\Auth\SetPasswordController;
use App\Http\Controllers\Auth\PasswordResetController;
use App\Http\Controllers\Admin\UserController;

// èªè¨¼APIï¼ˆã‚²ã‚¹ãƒˆï¼‰
Route::prefix('auth')->group(function () {
    Route::post('/login', [LoginController::class, 'login']);
    Route::post('/forgot-password', [PasswordResetController::class, 'forgot']);
    Route::post('/reset-password', [PasswordResetController::class, 'reset']);
    Route::post('/verify-token', [SetPasswordController::class, 'verify']);
    Route::post('/set-password', [SetPasswordController::class, 'setPassword']);
});

// èªè¨¼APIï¼ˆèªè¨¼å¿…é ˆï¼‰
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/auth/logout', [LoginController::class, 'logout']);
    Route::get('/auth/me', [LoginController::class, 'me']);
});

// ç®¡ç†è€…API
Route::middleware(['auth:sanctum', 'check.role:admin'])->prefix('admin')->group(function () {
    Route::apiResource('users', UserController::class);
});
```

---

## 10. ãƒ†ã‚¹ãƒˆ

### å˜ä½“ãƒ†ã‚¹ãƒˆ

```php
// tests/Feature/Auth/LoginTest.php
<?php

namespace Tests\Feature\Auth;

use App\Models\User;
use App\Models\Role;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class LoginTest extends TestCase
{
    use RefreshDatabase;

    public function test_user_can_login_with_correct_credentials()
    {
        $user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password123'),
            'status' => 'approved',
        ]);

        $response = $this->postJson('/api/auth/login', [
            'email' => 'test@example.com',
            'password' => 'password123',
        ]);

        $response->assertStatus(200)
            ->assertJsonStructure([
                'success',
                'data' => [
                    'user',
                    'token',
                ],
            ]);
    }

    public function test_user_cannot_login_with_incorrect_password()
    {
        $user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password123'),
        ]);

        $response = $this->postJson('/api/auth/login', [
            'email' => 'test@example.com',
            'password' => 'wrongpassword',
        ]);

        $response->assertStatus(422);
    }

    public function test_pending_user_cannot_login()
    {
        $user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password123'),
            'status' => 'pending',
        ]);

        $response = $this->postJson('/api/auth/login', [
            'email' => 'test@example.com',
            'password' => 'password123',
        ]);

        $response->assertStatus(422);
    }
}
```

---

## ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- [ ] `EmailVerificationToken` ãƒ¢ãƒ‡ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] `CreateAdminCommand` ä½œæˆ
- [ ] `LoginController` å®Ÿè£…
- [ ] `SetPasswordController` å®Ÿè£…
- [ ] `PasswordResetController` å®Ÿè£…
- [ ] `Admin/UserController` å®Ÿè£…
- [ ] ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹ä½œæˆï¼ˆSetPasswordMail, PasswordResetMailï¼‰
- [ ] ãƒ¡ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ä½œæˆ
- [ ] ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
- [ ] Middleware (`CheckRole`) ä½œæˆ
- [ ] Amazon SES è¨­å®š

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [ ] Login ãƒšãƒ¼ã‚¸æ›´æ–°
- [ ] SetPassword ãƒšãƒ¼ã‚¸ä½œæˆ
- [ ] ForgotPassword ãƒšãƒ¼ã‚¸ä½œæˆ
- [ ] ResetPassword ãƒšãƒ¼ã‚¸ä½œæˆ
- [ ] RoleSwitcher ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
- [ ] èªè¨¼çŠ¶æ…‹ç®¡ç†ï¼ˆContext or Zustandï¼‰
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆPrivateRouteï¼‰
- [ ] ãƒ­ãƒ¼ãƒ«åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ

---

**èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ä»•æ§˜æ›¸ãŒå®Œæˆã—ã¾ã—ãŸï¼ã“ã®ä»•æ§˜æ›¸ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ï¼** ğŸ‰
