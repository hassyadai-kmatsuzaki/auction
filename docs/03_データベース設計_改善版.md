# ãƒ¡ãƒ€ã‚«ãƒ©ã‚¤ãƒ–ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆæ”¹å–„ç‰ˆ v2.1ï¼‰

## ğŸ“‹ æ”¹å–„å†…å®¹ã‚µãƒãƒª

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€CTOãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åæ˜ ã—ãŸæ”¹å–„ç‰ˆã§ã™ã€‚

### ğŸ”§ ä¸»è¦ãªæ”¹å–„ç‚¹

1. âœ… **è¨­è¨ˆæ–¹é‡ã®æ˜ç¢ºåŒ–**ï¼šæ®µéšçš„æ‹¡å¼µå¯èƒ½ãªè¨­è¨ˆï¼ˆPhase 1â†’Phase 2ï¼‰
2. âœ… **bidsã®çŠ¶æ…‹/å±¥æ­´åˆ†é›¢**ï¼š`bid_participants`ï¼ˆçŠ¶æ…‹ï¼‰+ `bid_events`ï¼ˆå±¥æ­´ï¼‰
3. âœ… **ä¾¡æ ¼æ›´æ–°ã®æ ¹æ‹ è¨˜éŒ²**ï¼š`price_events`ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
4. âœ… **ç›£æŸ»ãƒ­ã‚°**ï¼š`audit_logs`ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆæœ€åˆã‹ã‚‰å®Ÿè£…ï¼‰
5. âœ… **won_itemsã®æ›´æ–°ãƒ«ãƒ¼ãƒ«æ˜æ–‡åŒ–**ï¼šåˆ¶ç´„ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
6. âœ… **é‡‘é¡ã®å‹ã¨ä¸¸ã‚è¦å‰‡**ï¼šæ˜ç¢ºåŒ–

---

## ğŸ“ è¨­è¨ˆæ–¹é‡

### Phase 1ï¼ˆåˆæœŸå®Ÿè£…ï¼‰ï¼šãƒ©ã‚¤ãƒ–ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ç‰¹åŒ–

```
ä½¿ç”¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼š
âœ… usersï¼ˆç®¡ç†è€…ãƒ»å‚åŠ è€…ï¼‰
âœ… auctionsï¼ˆã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
âœ… itemsï¼ˆå•†å“ï¼‰â€»seller_id ã¯ NULLï¼ˆç®¡ç†è€…ä¸€æ‹¬ç®¡ç†ï¼‰
âœ… item_mediaï¼ˆå‹•ç”»ãƒ»ç”»åƒï¼‰
âœ… lanesï¼ˆãƒ¬ãƒ¼ãƒ³ï¼‰
âœ… lane_itemsï¼ˆãƒ¬ãƒ¼ãƒ³å‰²ã‚Šå½“ã¦ï¼‰
âœ… bid_participantsï¼ˆå…¥æœ­å‚åŠ çŠ¶æ…‹ï¼‰â€»NEW
âœ… bid_eventsï¼ˆå…¥æœ­ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ï¼‰â€»NEW
âœ… price_eventsï¼ˆä¾¡æ ¼å¤‰å‹•å±¥æ­´ï¼‰â€»NEW
âœ… won_itemsï¼ˆè½æœ­ï¼‰
âœ… announcementsï¼ˆãŠçŸ¥ã‚‰ã›ï¼‰
âœ… announcement_readsï¼ˆæ—¢èª­ï¼‰
âœ… system_settingsï¼ˆè¨­å®šï¼‰
âœ… audit_logsï¼ˆç›£æŸ»ãƒ­ã‚°ï¼‰â€»NEW

æœªä½¿ç”¨ï¼ˆå°†æ¥ç”¨ï¼‰ï¼š
â¸ï¸ sellersï¼ˆå‡ºå“è€…ï¼‰â€»Phase 2ã§æœ‰åŠ¹åŒ–
â¸ï¸ depositsï¼ˆä¿è¨¼é‡‘ï¼‰â€»Phase 2ã§æœ‰åŠ¹åŒ–
â¸ï¸ auction_depositsï¼ˆä¿è¨¼é‡‘è¨­å®šï¼‰â€»Phase 2ã§æœ‰åŠ¹åŒ–
```

### Phase 2ï¼ˆå°†æ¥æ‹¡å¼µï¼‰ï¼šãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹è¦ç´ è¿½åŠ 

```
æœ‰åŠ¹åŒ–ï¼š
âœ… sellersï¼ˆå‡ºå“è€…ç®¡ç†ï¼‰
âœ… depositsï¼ˆä¿è¨¼é‡‘ç®¡ç†ï¼‰
âœ… auction_depositsï¼ˆä¿è¨¼é‡‘è¨­å®šï¼‰

è¿½åŠ ï¼š
âœ… seller_settlementsï¼ˆå‡ºå“è€…ç²¾ç®—ï¼‰â€»NEW
âœ… payoutsï¼ˆæŒ¯è¾¼ç®¡ç†ï¼‰â€»NEW
```

---

## ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ï¼ˆå…¨18ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

### Phase 1: ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ14ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

---

### 1. usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| name | VARCHAR(255) | NO | - | | æ°å |
| email | VARCHAR(255) | NO | - | UNQ | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| email_verified_at | TIMESTAMP | YES | NULL | | ãƒ¡ãƒ¼ãƒ«èªè¨¼æ—¥æ™‚ |
| password | VARCHAR(255) | NO | - | | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰ |
| user_type | ENUM('admin','participant') | NO | 'participant' | IDX | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥ |
| phone | VARCHAR(20) | YES | NULL | | é›»è©±ç•ªå· |
| postal_code | VARCHAR(10) | YES | NULL | | éƒµä¾¿ç•ªå· |
| prefecture | VARCHAR(50) | YES | NULL | | éƒ½é“åºœçœŒ |
| city | VARCHAR(100) | YES | NULL | | å¸‚åŒºç”ºæ‘ |
| address_line1 | VARCHAR(255) | YES | NULL | | ä½æ‰€1ï¼ˆç•ªåœ°ï¼‰ |
| address_line2 | VARCHAR(255) | YES | NULL | | ä½æ‰€2ï¼ˆå»ºç‰©åç­‰ï¼‰ |
| status | ENUM('pending','approved','suspended','rejected') | NO | 'pending' | IDX | æ‰¿èªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| approved_at | TIMESTAMP | YES | NULL | | æ‰¿èªæ—¥æ™‚ |
| approved_by | BIGINT UNSIGNED | YES | NULL | FK | æ‰¿èªè€…IDï¼ˆç®¡ç†è€…ï¼‰ |
| rejected_reason | TEXT | YES | NULL | | å´ä¸‹ç†ç”± |
| last_login_at | TIMESTAMP | YES | NULL | | æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ |
| is_active | BOOLEAN | NO | TRUE | | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| remember_token | VARCHAR(100) | YES | NULL | | ãƒ­ã‚°ã‚¤ãƒ³ç¶­æŒãƒˆãƒ¼ã‚¯ãƒ³ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |
| deleted_at | TIMESTAMP | YES | NULL | | è«–ç†å‰Šé™¤æ—¥æ™‚ |

---

### 2. sellersï¼ˆå‡ºå“è€…ï¼‰â€»Phase 2ã§æœ‰åŠ¹åŒ–

**å¤‰æ›´ç‚¹**ï¼š`is_enabled`ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ï¼ˆPhase 1ã§ã¯å…¨ã¦FALSEï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | å‡ºå“è€…ID |
| seller_code | VARCHAR(50) | NO | - | UNQ | å‡ºå“è€…ã‚³ãƒ¼ãƒ‰ï¼ˆè­˜åˆ¥ç”¨ï¼‰ |
| seller_name | VARCHAR(255) | NO | - | | å‡ºå“è€…åï¼ˆå±‹å·ãƒ»æ°åï¼‰ |
| contact_name | VARCHAR(255) | YES | NULL | | æ‹…å½“è€…å |
| email | VARCHAR(255) | NO | - | IDX | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| phone | VARCHAR(20) | NO | - | | é›»è©±ç•ªå· |
| postal_code | VARCHAR(10) | YES | NULL | | éƒµä¾¿ç•ªå· |
| prefecture | VARCHAR(50) | YES | NULL | | éƒ½é“åºœçœŒ |
| city | VARCHAR(100) | YES | NULL | | å¸‚åŒºç”ºæ‘ |
| address_line1 | VARCHAR(255) | YES | NULL | | ä½æ‰€1 |
| address_line2 | VARCHAR(255) | YES | NULL | | ä½æ‰€2 |
| bank_name | VARCHAR(100) | YES | NULL | | éŠ€è¡Œå |
| bank_branch | VARCHAR(100) | YES | NULL | | æ”¯åº—å |
| account_type | ENUM('checking','savings') | YES | NULL | | å£åº§ç¨®åˆ¥ |
| account_number | VARCHAR(20) | YES | NULL | | å£åº§ç•ªå· |
| account_holder | VARCHAR(100) | YES | NULL | | å£åº§åç¾© |
| commission_rate | DECIMAL(5,2) | NO | 10.00 | | æ‰‹æ•°æ–™ç‡ï¼ˆ%ï¼‰ |
| notes | TEXT | YES | NULL | | å‚™è€ƒ |
| **is_enabled** | **BOOLEAN** | **NO** | **FALSE** | **IDX** | **æ©Ÿèƒ½æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆPhase 2ã§TRUEï¼‰** |
| is_active | BOOLEAN | NO | TRUE | IDX | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
```sql
PRIMARY KEY (id)
UNIQUE KEY uk_seller_code (seller_code)
INDEX idx_email (email)
INDEX idx_enabled (is_enabled)
INDEX idx_active (is_active)
```

---

### 3. auctionsï¼ˆã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 4. auction_depositsï¼ˆã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ä¿è¨¼é‡‘è¨­å®šï¼‰â€»Phase 2ã§æœ‰åŠ¹åŒ–

**å¤‰æ›´ç‚¹**ï¼š`is_enabled`ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ID |
| auction_id | BIGINT UNSIGNED | NO | - | FK,UNQ | ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ID |
| deposit_amount | DECIMAL(10,2) | NO | 0.00 | | ä¿è¨¼é‡‘é¡ |
| deposit_type | ENUM('none','fixed','flexible') | NO | 'none' | | ä¿è¨¼é‡‘ã‚¿ã‚¤ãƒ— |
| description | TEXT | YES | NULL | | èª¬æ˜ |
| **is_enabled** | **BOOLEAN** | **NO** | **FALSE** | | **æ©Ÿèƒ½æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆPhase 2ã§TRUEï¼‰** |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |

---

### 5. depositsï¼ˆä¿è¨¼é‡‘ç®¡ç†ï¼‰â€»Phase 2ã§æœ‰åŠ¹åŒ–

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ã€Phase 1ã§ã¯æœªä½¿ç”¨ï¼‰

---

### 6. itemsï¼ˆç”Ÿä½“/å•†å“ï¼‰

**å¤‰æ›´ç‚¹**ï¼š`seller_id`ã‚’NULLABLEåŒ–ã€ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ç”Ÿä½“ID |
| auction_id | BIGINT UNSIGNED | NO | - | FK,IDX | ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ID |
| **seller_id** | **BIGINT UNSIGNED** | **YES** | **NULL** | **FK,IDX** | **å‡ºå“è€…IDï¼ˆPhase 1ã§ã¯ NULL=ç®¡ç†è€…ç®¡ç†ï¼‰** |
| item_number | INT UNSIGNED | NO | - | IDX | ç”Ÿä½“ç•ªå·ï¼ˆã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³å†…ï¼‰ |
| species_name | VARCHAR(255) | NO | - | | å“ç¨®å |
| quantity | INT UNSIGNED | NO | 1 | | åŒ¹æ•° |
| start_price | DECIMAL(10,2) | NO | 100.00 | | é–‹å§‹ä¾¡æ ¼ï¼ˆ1åŒ¹ã‚ãŸã‚Šï¼‰ |
| current_price | DECIMAL(10,2) | NO | 100.00 | | ç¾åœ¨ä¾¡æ ¼ï¼ˆ1åŒ¹ã‚ãŸã‚Šï¼‰ |
| reserve_price | DECIMAL(10,2) | YES | NULL | | æœ€ä½è½æœ­ä¾¡æ ¼ |
| estimated_price | DECIMAL(10,2) | YES | NULL | | è½æœ­æƒ³å®šé‡‘é¡ |
| bid_increment | DECIMAL(10,2) | NO | 100.00 | | å…¥æœ­å˜ä½ |
| inspection_info | TEXT | YES | NULL | | å¯©æŸ»æƒ…å ± |
| individual_info | TEXT | YES | NULL | | å€‹ä½“æƒ…å ±ï¼ˆå‡ºå“è€…è¨˜è¼‰ï¼‰ |
| notes | TEXT | YES | NULL | | å‚™è€ƒ |
| is_premium | BOOLEAN | NO | FALSE | IDX | ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ãƒ•ãƒ©ã‚° |
| premium_fee | DECIMAL(10,2) | YES | NULL | | ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³æ–™é‡‘ |
| thumbnail_path | VARCHAR(500) | YES | NULL | | ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãƒ‘ã‚¹ |
| status | ENUM('draft','registered','live','sold','unsold','cancelled') | NO | 'draft' | IDX | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| unsold_action | ENUM('return','free_pickup','relist') | YES | 'return' | | æœªè½æœ­æ™‚å¯¾å¿œ |
| storage_fee | DECIMAL(10,2) | YES | NULL | | ä¿ç®¡æ–™ï¼ˆæ¬¡å›å‡ºå“æ™‚ï¼‰ |
| live_started_at | TIMESTAMP | YES | NULL | | ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹æ—¥æ™‚ |
| live_ended_at | TIMESTAMP | YES | NULL | | ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ—¥æ™‚ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
```sql
PRIMARY KEY (id)
UNIQUE KEY uk_auction_item_number (auction_id, item_number)
INDEX idx_auction (auction_id)
INDEX idx_seller (seller_id)
INDEX idx_status (status)
INDEX idx_premium (is_premium)
INDEX idx_auction_status (auction_id, status, item_number)
FOREIGN KEY fk_auction_id (auction_id) REFERENCES auctions(id) ON DELETE CASCADE
FOREIGN KEY fk_seller_id (seller_id) REFERENCES sellers(id) ON DELETE SET NULL
```

**åˆ¶ç´„**
- Phase 1ã§ã¯ `seller_id IS NULL`ï¼ˆç®¡ç†è€…ä¸€æ‹¬ç®¡ç†ï¼‰
- Phase 2ã§ã¯ `seller_id IS NOT NULL`ï¼ˆå‡ºå“è€…ç®¡ç†ï¼‰

---

### 7. item_mediaï¼ˆç”Ÿä½“ãƒ¡ãƒ‡ã‚£ã‚¢ï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 8. lanesï¼ˆãƒ¬ãƒ¼ãƒ³ï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 9. lane_itemsï¼ˆãƒ¬ãƒ¼ãƒ³å•†å“å‰²ã‚Šå½“ã¦ï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 10. bid_participantsï¼ˆå…¥æœ­å‚åŠ çŠ¶æ…‹ï¼‰â€»NEW

**ç›®çš„**ï¼šå…¥æœ­è€…ã®ON/OFFçŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ID |
| item_id | BIGINT UNSIGNED | NO | - | FK,IDX | ç”Ÿä½“ID |
| user_id | BIGINT UNSIGNED | NO | - | FK,IDX | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| is_active | BOOLEAN | NO | TRUE | IDX | å…¥æœ­å‚åŠ ä¸­ãƒ•ãƒ©ã‚° |
| activated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | å‚åŠ é–‹å§‹æ—¥æ™‚ |
| deactivated_at | TIMESTAMP | YES | NULL | | å‚åŠ çµ‚äº†æ—¥æ™‚ |
| ip_address | VARCHAR(45) | YES | NULL | | IPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| user_agent | TEXT | YES | NULL | | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
```sql
PRIMARY KEY (id)
UNIQUE KEY uk_item_user (item_id, user_id)
INDEX idx_item_active (item_id, is_active)
INDEX idx_user (user_id)
FOREIGN KEY fk_item_id (item_id) REFERENCES items(id) ON DELETE CASCADE
FOREIGN KEY fk_user_id (user_id) REFERENCES users(id) ON DELETE CASCADE
```

**åˆ¶ç´„**
- 1å•†å“Ã—1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼ˆuk_item_userï¼‰
- `is_active = TRUE` ã§å‚åŠ ä¸­ã€`FALSE` ã§é›¢è„±
- é›¢è„±æ™‚ã« `deactivated_at` ã‚’è¨˜éŒ²

---

### 11. bid_eventsï¼ˆå…¥æœ­ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ï¼‰â€»NEW

**ç›®çš„**ï¼šã™ã¹ã¦ã®å…¥æœ­é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸å¤‰ã®å±¥æ­´ã¨ã—ã¦è¨˜éŒ²

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ã‚¤ãƒ™ãƒ³ãƒˆID |
| item_id | BIGINT UNSIGNED | NO | - | FK,IDX | ç”Ÿä½“ID |
| user_id | BIGINT UNSIGNED | NO | - | FK,IDX | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| event_type | ENUM('join','leave','price_accept','auto_raise','manual_raise','win','lose') | NO | - | IDX | ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ |
| price_at_event | DECIMAL(10,2) | YES | NULL | | ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã®ä¾¡æ ¼ |
| metadata | JSON | YES | NULL | | è¿½åŠ æƒ…å ±ï¼ˆä»»æ„ï¼‰ |
| ip_address | VARCHAR(45) | YES | NULL | | IPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| user_agent | TEXT | YES | NULL | | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | IDX | ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ—¥æ™‚ |

**ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥**
- `join`: å…¥æœ­å‚åŠ ï¼ˆONãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼‰
- `leave`: å…¥æœ­é›¢è„±ï¼ˆOFFãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼‰
- `price_accept`: ä¾¡æ ¼ä¸Šæ˜‡ã‚’å—ã‘å…¥ã‚Œï¼ˆONã®ã¾ã¾ï¼‰
- `auto_raise`: è‡ªå‹•ä¾¡æ ¼ä¸Šæ˜‡ï¼ˆ3ç§’çµŒéï¼‰
- `manual_raise`: æ‰‹å‹•ä¾¡æ ¼ä¸Šæ˜‡ï¼ˆç®¡ç†è€…æ“ä½œï¼‰
- `win`: è½æœ­
- `lose`: è½æœ­å¤±æ•—

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
```sql
PRIMARY KEY (id)
INDEX idx_item_created (item_id, created_at DESC)
INDEX idx_user (user_id)
INDEX idx_event_type (event_type)
INDEX idx_created (created_at)
FOREIGN KEY fk_item_id (item_id) REFERENCES items(id) ON DELETE CASCADE
FOREIGN KEY fk_user_id (user_id) REFERENCES users(id) ON DELETE CASCADE
```

**ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆæ¨å¥¨ï¼‰**
```sql
-- æœˆæ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°
PARTITION BY RANGE (TO_DAYS(created_at)) (
    PARTITION p202601 VALUES LESS THAN (TO_DAYS('2026-02-01')),
    PARTITION p202602 VALUES LESS THAN (TO_DAYS('2026-03-01')),
    ...
);
```

---

### 12. price_eventsï¼ˆä¾¡æ ¼å¤‰å‹•å±¥æ­´ï¼‰â€»NEW

**ç›®çš„**ï¼šä¾¡æ ¼å¤‰å‹•ã®æ ¹æ‹ ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨˜éŒ²ï¼ˆæ•´åˆæ€§ã®ã€Œå”¯ä¸€ã®çœŸå®Ÿã€ï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ã‚¤ãƒ™ãƒ³ãƒˆID |
| item_id | BIGINT UNSIGNED | NO | - | FK,IDX | ç”Ÿä½“ID |
| old_price | DECIMAL(10,2) | NO | - | | å¤‰æ›´å‰ä¾¡æ ¼ |
| new_price | DECIMAL(10,2) | NO | - | | å¤‰æ›´å¾Œä¾¡æ ¼ |
| reason | ENUM('auto_increment','manual_adjustment','bid_accepted','item_start','item_sold') | NO | - | IDX | å¤‰å‹•ç†ç”± |
| active_bidder_count | INT UNSIGNED | NO | 0 | | å¤‰å‹•æ™‚ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…æ•° |
| triggered_by | BIGINT UNSIGNED | YES | NULL | FK | å¤‰å‹•ã‚’å¼•ãèµ·ã“ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| metadata | JSON | YES | NULL | | è¿½åŠ æƒ…å ±ï¼ˆä»»æ„ï¼‰ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | IDX | å¤‰å‹•æ—¥æ™‚ |

**å¤‰å‹•ç†ç”±**
- `auto_increment`: è‡ªå‹•ä¸Šæ˜‡ï¼ˆ3ç§’çµŒéã€è¤‡æ•°äººå‚åŠ ï¼‰
- `manual_adjustment`: æ‰‹å‹•èª¿æ•´ï¼ˆç®¡ç†è€…ï¼‰
- `bid_accepted`: å…¥æœ­å—ä»˜ï¼ˆåˆå›å‚åŠ ï¼‰
- `item_start`: å•†å“é–‹å§‹ï¼ˆé–‹å§‹ä¾¡æ ¼è¨­å®šï¼‰
- `item_sold`: è½æœ­ç¢ºå®š

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
```sql
PRIMARY KEY (id)
INDEX idx_item_created (item_id, created_at DESC)
INDEX idx_reason (reason)
INDEX idx_created (created_at)
FOREIGN KEY fk_item_id (item_id) REFERENCES items(id) ON DELETE CASCADE
FOREIGN KEY fk_triggered_by (triggered_by) REFERENCES users(id) ON DELETE SET NULL
```

**ä½¿ã„æ–¹**
```sql
-- items.current_price ã®æ›´æ–°ã¯å¿…ãš price_events ã¨ä¸€ç·’ã«å®Ÿè¡Œ
START TRANSACTION;

INSERT INTO price_events (item_id, old_price, new_price, reason, active_bidder_count)
VALUES (123, 1000, 1100, 'auto_increment', 3);

UPDATE items SET current_price = 1100 WHERE id = 123;

COMMIT;
```

---

### 13. won_itemsï¼ˆè½æœ­ï¼‰

**å¤‰æ›´ç‚¹**ï¼šæ›´æ–°ãƒ«ãƒ¼ãƒ«ã‚’æ˜æ–‡åŒ–ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆãƒ»åˆ¶ç´„ã‚’è¿½åŠ 

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | è½æœ­ID |
| item_id | BIGINT UNSIGNED | NO | - | FK,UNQ | ç”Ÿä½“ID |
| winner_id | BIGINT UNSIGNED | NO | - | FK,IDX | è½æœ­è€…ID |
| winning_price | DECIMAL(10,2) | NO | - | | è½æœ­ä¾¡æ ¼ï¼ˆ1åŒ¹ã‚ãŸã‚Šï¼‰ |
| quantity | INT UNSIGNED | NO | - | | åŒ¹æ•° |
| total_amount | DECIMAL(10,2) | NO | - | | åˆè¨ˆé‡‘é¡ |
| commission_rate | DECIMAL(5,2) | NO | 10.00 | | æ‰‹æ•°æ–™ç‡ï¼ˆ%ï¼‰ |
| commission_amount | DECIMAL(10,2) | NO | 0.00 | | æ‰‹æ•°æ–™é¡ |
| seller_amount | DECIMAL(10,2) | NO | 0.00 | | å‡ºå“è€…å—å–é¡ |
| payment_status | ENUM('pending','paid','confirmed','refunded') | NO | 'pending' | IDX | æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| payment_method | ENUM('bank_transfer','credit_card','cash','onsite') | YES | NULL | | æ”¯æ‰•ã„æ–¹æ³• |
| paid_at | TIMESTAMP | YES | NULL | | å…¥é‡‘æ—¥æ™‚ |
| payment_confirmed_at | TIMESTAMP | YES | NULL | | å…¥é‡‘ç¢ºèªæ—¥æ™‚ |
| payment_deadline | TIMESTAMP | YES | NULL | IDX | å…¥é‡‘æœŸé™ |
| delivery_method | ENUM('shipping','pickup') | NO | 'shipping' | | å—å–æ–¹æ³• |
| pickup_datetime | TIMESTAMP | YES | NULL | | ç¾åœ°å¼•å–å¸Œæœ›æ—¥æ™‚ |
| pickup_timeslot | ENUM('day1_10-12','day1_12-14','day1_14-16','day1_16-18','day2_10-12','day2_12-14','day2_14-16','day2_16-18') | YES | NULL | | å¼•å–æ™‚é–“å¸¯ |
| delivery_status | ENUM('pending','preparing','shipped','completed','cancelled') | NO | 'pending' | IDX | ç™ºé€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| **shipping_locked_at** | **TIMESTAMP** | **YES** | **NULL** | | **é…é€å…ˆãƒ­ãƒƒã‚¯æ—¥æ™‚ï¼ˆå…¥é‡‘ç¢ºèªæ™‚ï¼‰** |
| shipping_postal_code | VARCHAR(10) | YES | NULL | | é…é€å…ˆéƒµä¾¿ç•ªå· |
| shipping_prefecture | VARCHAR(50) | YES | NULL | | é…é€å…ˆéƒ½é“åºœçœŒ |
| shipping_city | VARCHAR(100) | YES | NULL | | é…é€å…ˆå¸‚åŒºç”ºæ‘ |
| shipping_address_line1 | VARCHAR(255) | YES | NULL | | é…é€å…ˆä½æ‰€1 |
| shipping_address_line2 | VARCHAR(255) | YES | NULL | | é…é€å…ˆä½æ‰€2 |
| shipping_name | VARCHAR(255) | YES | NULL | | å—å–äººæ°å |
| shipping_phone | VARCHAR(20) | YES | NULL | | å—å–äººé›»è©±ç•ªå· |
| shipping_company | VARCHAR(100) | YES | NULL | | é…é€æ¥­è€… |
| tracking_number | VARCHAR(100) | YES | NULL | | è¿½è·¡ç•ªå· |
| shipped_at | TIMESTAMP | YES | NULL | | ç™ºé€æ—¥æ™‚ |
| delivered_at | TIMESTAMP | YES | NULL | | é…é”å®Œäº†æ—¥æ™‚ |
| notes | TEXT | YES | NULL | | å‚™è€ƒ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |

**é…é€å…ˆæ›´æ–°ãƒ«ãƒ¼ãƒ«**
```
âœ… payment_status = 'pending' â†’ é…é€å…ˆç·¨é›†å¯èƒ½
âŒ payment_status = 'paid' or 'confirmed' â†’ é…é€å…ˆç·¨é›†ä¸å¯ï¼ˆshipping_locked_at ã«æ—¥æ™‚è¨˜éŒ²ï¼‰
âœ… usersãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½æ‰€ã¯å‚ç…§å…ƒã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã ãŒã€won_itemsãŒã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆæ­£ï¼‰
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§ã®åˆ¶å¾¡**
```php
// é…é€å…ˆæ›´æ–°æ™‚ã®ãƒã‚§ãƒƒã‚¯
if ($wonItem->shipping_locked_at !== null) {
    throw new Exception('å…¥é‡‘ç¢ºèªå¾Œã¯é…é€å…ˆã‚’å¤‰æ›´ã§ãã¾ã›ã‚“');
}

// å…¥é‡‘ç¢ºèªæ™‚ã«ãƒ­ãƒƒã‚¯
$wonItem->update([
    'payment_status' => 'confirmed',
    'payment_confirmed_at' => now(),
    'shipping_locked_at' => now(), // ãƒ­ãƒƒã‚¯
]);
```

---

### 14. announcementsï¼ˆãŠçŸ¥ã‚‰ã›ï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 15. announcement_readsï¼ˆãŠçŸ¥ã‚‰ã›æ—¢èª­ç®¡ç†ï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 16. system_settingsï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰

**å¤‰æ›´ãªã—**ï¼ˆå‰ç‰ˆã¨åŒã˜ï¼‰

---

### 17. audit_logsï¼ˆç›£æŸ»ãƒ­ã‚°ï¼‰â€»NEW

**ç›®çš„**ï¼šé‡è¦ãªæ“ä½œã‚’è¨˜éŒ²ï¼ˆç›£æŸ»ãƒ»ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œãƒ»ä¸æ­£æ¤œçŸ¥ï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ãƒ­ã‚°ID |
| user_id | BIGINT UNSIGNED | YES | NULL | FK,IDX | æ“ä½œãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| action | VARCHAR(100) | NO | - | IDX | æ“ä½œç¨®åˆ¥ |
| auditable_type | VARCHAR(100) | NO | - | IDX | å¯¾è±¡ãƒ¢ãƒ‡ãƒ« |
| auditable_id | BIGINT UNSIGNED | YES | NULL | IDX | å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ID |
| old_values | JSON | YES | NULL | | å¤‰æ›´å‰ã®å€¤ |
| new_values | JSON | YES | NULL | | å¤‰æ›´å¾Œã®å€¤ |
| ip_address | VARCHAR(45) | YES | NULL | | IPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| user_agent | TEXT | YES | NULL | | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | IDX | æ“ä½œæ—¥æ™‚ |

**è¨˜éŒ²å¯¾è±¡æ“ä½œ**
- `user.approved`: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª
- `user.rejected`: ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ä¸‹
- `user.suspended`: ãƒ¦ãƒ¼ã‚¶ãƒ¼åœæ­¢
- `auction.created`: ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
- `auction.started`: ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
- `auction.finished`: ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†
- `item.created`: å•†å“ç™»éŒ²
- `item.updated`: å•†å“æ›´æ–°
- `item.deleted`: å•†å“å‰Šé™¤
- `won_item.created`: è½æœ­ç¢ºå®š
- `won_item.payment_confirmed`: å…¥é‡‘ç¢ºèª
- `won_item.shipped`: ç™ºé€å®Œäº†
- `system_setting.updated`: ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
```sql
PRIMARY KEY (id)
INDEX idx_user (user_id)
INDEX idx_action (action)
INDEX idx_auditable (auditable_type, auditable_id)
INDEX idx_created (created_at)
FOREIGN KEY fk_user_id (user_id) REFERENCES users(id) ON DELETE SET NULL
```

**ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆæ¨å¥¨ï¼‰**
```sql
-- å¹´æ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°
PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    ...
);
```

**ä½¿ç”¨ä¾‹**
```php
// ç›£æŸ»ãƒ­ã‚°ã®è¨˜éŒ²
AuditLog::create([
    'user_id' => auth()->id(),
    'action' => 'won_item.payment_confirmed',
    'auditable_type' => 'WonItem',
    'auditable_id' => $wonItem->id,
    'old_values' => ['payment_status' => 'paid'],
    'new_values' => ['payment_status' => 'confirmed', 'payment_confirmed_at' => now()],
    'ip_address' => request()->ip(),
    'user_agent' => request()->userAgent(),
]);
```

---

### Phase 2: æ‹¡å¼µãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆPhase 2ã§è¿½åŠ ï¼‰

---

### 18. seller_settlementsï¼ˆå‡ºå“è€…ç²¾ç®—ï¼‰â€»Phase 2ã§è¿½åŠ 

**ç›®çš„**ï¼šå‡ºå“è€…ã¸ã®ç²¾ç®—ãƒ»æŒ¯è¾¼ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚­ãƒ¼ | èª¬æ˜ |
|---------|---|------|----------|------|------|
| id | BIGINT UNSIGNED | NO | AUTO | PK | ç²¾ç®—ID |
| seller_id | BIGINT UNSIGNED | NO | - | FK,IDX | å‡ºå“è€…ID |
| auction_id | BIGINT UNSIGNED | NO | - | FK,IDX | ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ID |
| settlement_period_start | DATE | NO | - | | ç²¾ç®—æœŸé–“é–‹å§‹ |
| settlement_period_end | DATE | NO | - | | ç²¾ç®—æœŸé–“çµ‚äº† |
| total_sales_amount | DECIMAL(10,2) | NO | 0.00 | | ç·å£²ä¸Šé¡ |
| total_commission_amount | DECIMAL(10,2) | NO | 0.00 | | ç·æ‰‹æ•°æ–™é¡ |
| net_amount | DECIMAL(10,2) | NO | 0.00 | | æŒ¯è¾¼é¡ï¼ˆå£²ä¸Š-æ‰‹æ•°æ–™ï¼‰ |
| status | ENUM('pending','confirmed','paid') | NO | 'pending' | IDX | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| confirmed_at | TIMESTAMP | YES | NULL | | ç¢ºå®šæ—¥æ™‚ |
| paid_at | TIMESTAMP | YES | NULL | | æŒ¯è¾¼æ—¥æ™‚ |
| payment_reference | VARCHAR(100) | YES | NULL | | æŒ¯è¾¼å‚ç…§ç•ªå· |
| notes | TEXT | YES | NULL | | å‚™è€ƒ |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | | æ›´æ–°æ—¥æ™‚ |

---

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›³ï¼ˆæ”¹å–„ç‰ˆï¼‰

```mermaid
erDiagram
    %% Phase 1: ã‚³ã‚¢ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    users ||--o{ bid_participants : "å…¥æœ­å‚åŠ "
    users ||--o{ bid_events : "å…¥æœ­ã‚¤ãƒ™ãƒ³ãƒˆ"
    users ||--o{ won_items : "è½æœ­"
    users ||--o{ audit_logs : "æ“ä½œ"
    
    %% Phase 2: æ‹¡å¼µãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå°†æ¥ï¼‰
    users ||--o{ deposits : "ä¿è¨¼é‡‘"
    sellers ||--o{ items : "å‡ºå“"
    sellers ||--o{ seller_settlements : "ç²¾ç®—"
    
    auctions ||--o{ items : "å•†å“"
    auctions ||--o{ lanes : "ãƒ¬ãƒ¼ãƒ³"
    auctions ||--|| auction_deposits : "ä¿è¨¼é‡‘è¨­å®š"
    auctions ||--o{ deposits : "ä¿è¨¼é‡‘"
    
    items ||--o{ item_media : "ãƒ¡ãƒ‡ã‚£ã‚¢"
    items ||--o{ bid_participants : "å…¥æœ­å‚åŠ è€…"
    items ||--o{ bid_events : "å…¥æœ­ã‚¤ãƒ™ãƒ³ãƒˆ"
    items ||--o{ price_events : "ä¾¡æ ¼å¤‰å‹•"
    items ||--|| won_items : "è½æœ­"
    items ||--|| lane_items : "ãƒ¬ãƒ¼ãƒ³å‰²å½“"
    
    lanes ||--o{ lane_items : "å•†å“å‰²å½“"
    
    announcements ||--o{ announcement_reads : "æ—¢èª­"
```

---

## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆï¼ˆæ”¹å–„ç‰ˆï¼‰

### 1. å…¥æœ­å‚åŠ å‡¦ç†ï¼ˆONãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼‰

```sql
START TRANSACTION;

-- 1. å‚åŠ çŠ¶æ…‹ã‚’è¨˜éŒ²/æ›´æ–°
INSERT INTO bid_participants (item_id, user_id, is_active, activated_at, ip_address)
VALUES (?, ?, TRUE, NOW(), ?)
ON DUPLICATE KEY UPDATE
    is_active = TRUE,
    activated_at = NOW(),
    deactivated_at = NULL;

-- 2. ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
INSERT INTO bid_events (item_id, user_id, event_type, price_at_event, ip_address)
VALUES (?, ?, 'join', (SELECT current_price FROM items WHERE id = ?), ?);

-- 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
SET @active_count = (
    SELECT COUNT(*) FROM bid_participants
    WHERE item_id = ? AND is_active = TRUE
);

-- 4. è¤‡æ•°äººå‚åŠ ãªã‚‰ä¾¡æ ¼ä¸Šæ˜‡ãƒ­ã‚¸ãƒƒã‚¯é–‹å§‹ï¼ˆåˆ¥é€”Job/WebSocketï¼‰

COMMIT;
```

### 2. ä¾¡æ ¼è‡ªå‹•ä¸Šæ˜‡å‡¦ç†ï¼ˆ3ç§’çµŒéï¼‰

```sql
START TRANSACTION;

-- 1. ç¾åœ¨ä¾¡æ ¼ã‚’å–å¾—ï¼ˆè¡Œãƒ­ãƒƒã‚¯ï¼‰
SELECT id, current_price, bid_increment
FROM items
WHERE id = ? AND status = 'live'
FOR UPDATE;

-- 2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…æ•°ã‚’ç¢ºèª
SET @active_count = (
    SELECT COUNT(*) FROM bid_participants
    WHERE item_id = ? AND is_active = TRUE
);

-- 3. è¤‡æ•°äººå‚åŠ ä¸­ã®ã¿ä¾¡æ ¼ä¸Šæ˜‡
IF @active_count >= 2 THEN
    -- ä¾¡æ ¼å¤‰å‹•ã‚’è¨˜éŒ²
    INSERT INTO price_events (item_id, old_price, new_price, reason, active_bidder_count)
    VALUES (?, @old_price, @new_price, 'auto_increment', @active_count);
    
    -- ä¾¡æ ¼ã‚’æ›´æ–°
    UPDATE items SET current_price = @new_price WHERE id = ?;
    
    -- å„å‚åŠ è€…ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
    INSERT INTO bid_events (item_id, user_id, event_type, price_at_event)
    SELECT ?, user_id, 'price_accept', @new_price
    FROM bid_participants
    WHERE item_id = ? AND is_active = TRUE;
END IF;

COMMIT;
```

### 3. è½æœ­ç¢ºå®šå‡¦ç†

```sql
START TRANSACTION;

-- 1. æœ€çµ‚ä¾¡æ ¼ã¨å‚åŠ è€…ã‚’å–å¾—ï¼ˆè¡Œãƒ­ãƒƒã‚¯ï¼‰
SELECT id, current_price, quantity
FROM items
WHERE id = ? AND status = 'live'
FOR UPDATE;

-- 2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…ã‚’å–å¾—
SELECT user_id FROM bid_participants
WHERE item_id = ? AND is_active = TRUE
ORDER BY activated_at ASC
LIMIT 1; -- æœ€åˆã«å‚åŠ ã—ãŸäººãŒè½æœ­ï¼ˆor ãƒ©ãƒ³ãƒ€ãƒ ï¼‰

-- 3. è½æœ­ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
INSERT INTO won_items (
    item_id, winner_id, winning_price, quantity, total_amount,
    payment_deadline, ...
) VALUES (...);

-- 4. å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
UPDATE items SET status = 'sold', live_ended_at = NOW() WHERE id = ?;

-- 5. è½æœ­ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
INSERT INTO bid_events (item_id, user_id, event_type, price_at_event)
VALUES (?, @winner_id, 'win', @winning_price);

-- è½æœ­å¤±æ•—è€…ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
INSERT INTO bid_events (item_id, user_id, event_type, price_at_event)
SELECT ?, user_id, 'lose', @winning_price
FROM bid_participants
WHERE item_id = ? AND is_active = TRUE AND user_id != @winner_id;

-- 6. ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
INSERT INTO audit_logs (user_id, action, auditable_type, auditable_id, new_values)
VALUES (?, 'won_item.created', 'WonItem', LAST_INSERT_ID(), JSON_OBJECT(...));

COMMIT;
```

---

## é‡‘é¡ã®å‹ã¨ä¸¸ã‚è¦å‰‡

### ğŸ’´ é‡‘é¡ã®å‹ï¼šDECIMAL(10,2)

**ç†ç”±**ï¼š
- JPYã§ã®é‹ç”¨ã‚’æƒ³å®š
- æœ€å¤§ 99,999,999.99 å††ã¾ã§å¯¾å¿œ
- å°æ•°ç¬¬2ä½ã¾ã§è¨˜éŒ²ï¼ˆå°†æ¥ã®æ‹¡å¼µæ€§ï¼‰

### ğŸ“ ä¸¸ã‚è¦å‰‡ï¼ˆæ˜æ–‡åŒ–ï¼‰

```php
// ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
'rounding_rule' => 'round_half_up', // å››æ¨äº”å…¥
'decimal_places' => 0, // JPYã¯å°æ•°ãªã—

// æ‰‹æ•°æ–™è¨ˆç®—
$commissionAmount = round($totalAmount * $commissionRate / 100, 0, PHP_ROUND_HALF_UP);
$sellerAmount = $totalAmount - $commissionAmount;

// DBã«ä¿å­˜å‰ã«å¿…ãšä¸¸ã‚ã‚‹
$wonItem->commission_amount = round($commissionAmount, 2);
$wonItem->seller_amount = round($sellerAmount, 2);
```

**æ•´æ•°å‹ï¼ˆBIGINTï¼‰ã¸ã®ç§»è¡Œã‚‚æ¤œè¨å¯**ï¼š
```sql
-- å°†æ¥çš„ã«JPYã‚ªãƒ³ãƒªãƒ¼ãŒç¢ºå®šã—ãŸã‚‰
ALTER TABLE items MODIFY COLUMN current_price BIGINT UNSIGNED COMMENT 'ä¾¡æ ¼(å††)';
ALTER TABLE won_items MODIFY COLUMN total_amount BIGINT UNSIGNED COMMENT 'åˆè¨ˆé‡‘é¡(å††)';
```

---

## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ï¼ˆæ”¹å–„ç‰ˆï¼‰

### 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥æœ­ç”¨

```sql
-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…ã®é«˜é€Ÿå–å¾—
bid_participants: (item_id, is_active)

-- ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã®é«˜é€Ÿå–å¾—ï¼ˆæ™‚ç³»åˆ—é †ï¼‰
bid_events: (item_id, created_at DESC)
bid_events: (user_id, created_at DESC)

-- ä¾¡æ ¼å¤‰å‹•å±¥æ­´ã®é«˜é€Ÿå–å¾—
price_events: (item_id, created_at DESC)
```

### 2. ç›£æŸ»ãƒ­ã‚°ç”¨

```sql
-- ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œå±¥æ­´
audit_logs: (user_id, created_at DESC)

-- ç‰¹å®šãƒ¬ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´å±¥æ­´
audit_logs: (auditable_type, auditable_id, created_at DESC)

-- ç‰¹å®šæ“ä½œã®å±¥æ­´
audit_logs: (action, created_at DESC)
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆæ”¹å–„ç‰ˆï¼‰

### 1. Redisæ´»ç”¨

```
# ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…ï¼ˆSETå‹ï¼‰
item:{item_id}:active_bidders â†’ SET {user_id1, user_id2, ...}

# ç¾åœ¨ä¾¡æ ¼ï¼ˆSTRINGå‹ï¼‰
item:{item_id}:current_price â†’ "1500"

# ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å…¥æœ­è€…æ•°ï¼ˆSTRINGå‹ï¼‰
item:{item_id}:active_count â†’ "3"
```

### 2. WebSocketã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥

```javascript
// ä¾¡æ ¼æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
{
  "event": "PriceUpdated",
  "item_id": 123,
  "old_price": 1000,
  "new_price": 1100,
  "active_bidder_count": 3,
  "timestamp": "2026-01-16T12:34:56Z"
}

// å…¥æœ­è€…å‚åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
{
  "event": "BidderJoined",
  "item_id": 123,
  "active_bidder_count": 2
}
```

---

## ã¾ã¨ã‚ï¼šæ”¹å–„ç‰ˆã®åˆ©ç‚¹

### âœ… 1. è¨­è¨ˆã®æ˜ç¢ºåŒ–
- Phase 1ï¼ˆåˆæœŸï¼‰ã¨Phase 2ï¼ˆæ‹¡å¼µï¼‰ã®å¢ƒç•ŒãŒæ˜ç¢º
- sellers/deposits ã¯ã€Œå°†æ¥ç”¨ã€ã¨ã—ã¦æ•´ç†

### âœ… 2. çŠ¶æ…‹ã¨å±¥æ­´ã®åˆ†é›¢
- `bid_participants`ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ…‹ï¼ˆæ›´æ–°ã•ã‚Œã‚‹ï¼‰
- `bid_events`ï¼šä¸å¤‰ã®å±¥æ­´ï¼ˆè¿½è¨˜ã®ã¿ï¼‰
- `price_events`ï¼šä¾¡æ ¼å¤‰å‹•ã®æ ¹æ‹ ï¼ˆæ•´åˆæ€§ã®çœŸå®Ÿï¼‰

### âœ… 3. ç›£æŸ»å¯¾å¿œ
- `audit_logs`ï¼šæœ€åˆã‹ã‚‰å®Ÿè£…
- ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œãƒ»ä¸æ­£æ¤œçŸ¥ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œãŒå®¹æ˜“

### âœ… 4. é‹ç”¨ã®å®‰å…¨æ€§
- `won_items.shipping_locked_at`ï¼šé…é€å…ˆå¤‰æ›´ãƒ«ãƒ¼ãƒ«ã‚’æ˜ç¢ºåŒ–
- é‡‘é¡ã®ä¸¸ã‚è¦å‰‡ã‚’æ˜æ–‡åŒ–
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã‚’æ˜ç¢ºåŒ–

### âœ… 5. æ‹¡å¼µæ€§
- Phase 2ã¸ã®ç§»è¡Œãƒ‘ã‚¹ãŒæ˜ç¢º
- å°†æ¥ã®æ•´æ•°å‹ã¸ã®ç§»è¡Œã‚‚è¦–é‡

---

**CTOãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å®Œå…¨ã«åæ˜ ã—ãŸã€å®Œç’§ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆæ”¹å–„ç‰ˆï¼‰ãŒå®Œæˆã—ã¾ã—ãŸï¼** ğŸ‰
