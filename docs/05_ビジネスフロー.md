# メダカライブオークションシステム - ビジネスフロー

## 全体フロー図

```
[参加者登録申請] → [管理者承認] → [ログイン可能]
                                      ↓
                            [オークション会場参加]
                                      ↓
                            [リアルタイム入札] → [落札]
                                      ↓
                            [請求書確認] → [振込] → [商品発送]
```

---

## 1. ユーザー登録・承認フロー

### 1.1 参加者登録申請

**タイミング**: いつでも

1. ユーザーが登録画面にアクセス
2. 基本情報を入力
   - 氏名
   - メールアドレス
   - パスワード
   - 電話番号
   - 住所
3. 登録申請ボタンをクリック

**システム処理**
- `users` テーブルに登録（status: `pending`）
- 申請受付メールを送信
- 管理者に通知

---

### 1.2 管理者による承認

**タイミング**: 随時

1. 管理者が「ユーザー管理」画面にアクセス
2. 承認待ちユーザー一覧を確認
3. ユーザー情報を確認
4. 承認 or 却下を選択

**システム処理**
- 承認の場合:
  - `users.status` を `approved` に更新
  - `users.approved_at` に日時記録
  - `users.approved_by` に承認者ID記録
  - 承認完了メールを送信
- 却下の場合:
  - ユーザーを削除 or ステータスを `rejected` に
  - 却下理由をメールで通知

---

## 2. お知らせ配信フロー

### 2.1 お知らせ作成（管理者）

**タイミング**: オークション開催前など

1. 管理者が「お知らせ管理」画面にアクセス
2. 新規作成ボタンをクリック
3. お知らせ内容を入力
   - タイトル
   - 本文
   - 優先度（低/通常/高）
   - 公開期間
4. 公開ボタンをクリック

**システム処理**
- `announcements` テーブルに登録
- `is_published` を true に設定
- 全参加者にメール通知（オプション）

---

### 2.2 お知らせ閲覧（参加者）

**タイミング**: いつでも

1. 参加者がログイン
2. ホーム画面（お知らせ一覧）に未読お知らせが表示
3. お知らせをクリックして詳細を閲覧

**システム処理**
- `announcement_reads` テーブルに既読記録
- 未読カウントを減少

---

## 3. オークション準備フロー

### 3.1 オークション作成（管理者）

**タイミング**: 開催の1-2週間前

1. 管理者が「オークション管理」画面にアクセス
2. 新規作成ボタンをクリック
3. オークション情報を入力
   - タイトル
   - 開催日
   - 開始時刻
   - 説明
4. 作成ボタンをクリック

**システム処理**
- `auctions` テーブルに登録（status: `preparing`）
- 6つの `lanes` レコードを自動生成

---

### 3.2 生体（商品）登録（管理者）

**タイミング**: オークション前日

#### 午前: 生体受け取り
1. 配送で届いた生体の受取
2. 持込生体の受付
3. 生体の状態確認

#### 日中: 撮影作業
1. 水槽に移動
2. スタジオで撮影（30秒毎に入れ替え）
   - **通常プラン**:
     - 上見動画30秒
     - 横見動画30秒
   - **プレミアムプラン**（+300円）:
     - 上見個別撮影
     - 横見個別撮影
     - 追加写真3枚

#### 管理画面での登録
1. 管理者が「生体管理」画面にアクセス
2. 新規登録ボタンをクリック
3. 生体情報を入力
   - 品種名
   - 匹数
   - 個体情報
   - 審査情報
   - 開始価格
   - プレミアムプラン設定
4. 動画・画像をアップロード
5. サムネイル選択
6. 登録ボタンをクリック

**システム処理**
- `items` テーブルに登録
- `item_media` テーブルにメディア情報登録
- 生体番号を自動採番

---

### 3.3 レーン割り当て（管理者）

**タイミング**: 前日17時まで

1. 管理者が「生体管理」画面で全生体を確認
2. 出品順序を調整（ドラッグ&ドロップ）
   - プレミアムプラン商品を上位に配置
3. 「レーン自動割り当て」ボタンをクリック

**システム処理**
- 全生体を6レーンに均等に振り分け
- `lane_items` テーブルに割り当て情報を登録
- `lane_items.sequence_order` で順序を設定

---

### 3.4 開催前通知

**タイミング**: 前日17時

1. 全生体の登録・レーン割り当てが完了
2. お知らせを作成
3. 参加者に通知

**通知内容**
```
【オークション開催のお知らせ】
明日のオークションの準備が完了しました。
開催日時: 2025年11月12日 10:00〜
生体数: 120個体

オークション会場は当日10時からアクセス可能です。
```

---

## 4. オークション開催フロー

### 4.1 オークション開始（管理者）

**タイミング**: 当日10時

1. 管理者が「ライブオークション管理」画面にアクセス
2. 「オークション開始」ボタンをクリック

**システム処理**
- `auctions.status` を `live` に更新
- 全 `lanes.status` を `active` に更新
- 各レーンの最初の生体を `lanes.current_item_id` に設定
- WebSocket接続を開始
- 参加者がオークション会場にアクセス可能に

---

### 4.2 リアルタイム入札（参加者）

**オークション会場の動作**

1. 参加者がオークション会場画面にアクセス
2. 6レーンが同時表示される
3. 各生体に対して「ON/OFFボタン」で入札参加

**入札ロジック**

#### ONボタンを押した場合
```
1. 参加者Aが生体XのONボタンを押す
2. システムが `bids` テーブルに記録 (is_active: true)
3. 参加者Aの画面でボタンが緑色に変わる
4. 他の参加者の画面に入札者数が増加表示
```

#### 複数人が入札した場合
```
1. 参加者A、B、Cが同時にONにする
2. システムが3秒カウントダウン開始
3. 3秒後に価格が自動上昇（例: 800円 → 900円）
4. 全参加者の画面に新価格が表示される
5. まだ誰かがONのままなら、再度3秒カウント
```

#### 価格上昇ルール
- 複数人入札時は3秒ごとに上昇
- 上昇額: 現在価格の10%（最低50円）
- 1人だけになったら上昇停止
- 全員OFFになったら、最後にONにしていた人が落札

#### OFFボタンを押した場合
```
1. 参加者AがOFFボタンを押す
2. システムが `bids.is_active` を false に更新
3. 参加者Aの画面でボタンが灰色に戻る
4. 他の参加者が1人だけならカウント停止
```

**WebSocketによるリアルタイム更新**
```typescript
// 価格更新イベント
{
  "event": "PriceUpdated",
  "item_id": 1,
  "new_price": 900,
  "active_bidders_count": 3,
  "countdown_seconds": 3
}

// 入札者参加イベント
{
  "event": "BidderJoined",
  "item_id": 1,
  "active_bidders_count": 4
}

// 入札者離脱イベント
{
  "event": "BidderLeft",
  "item_id": 1,
  "active_bidders_count": 2
}
```

---

### 4.3 落札決定

**落札条件**
- 最後まで入札ONを維持した人（1人だけになった）
- 一定時間（10秒）他に入札者がいない状態が続いた場合

**落札時の処理**
1. システムが落札を確定
2. `won_items` テーブルに記録
   - 落札者ID
   - 落札価格
   - 合計金額
3. `items.status` を `sold` に更新
4. 次の生体がレーンに表示される
5. 落札者に通知送信

**レーン進行**
```
1. レーン1の生体1が落札される
2. システムが `lane_items` の次の生体を取得
3. `lanes.current_item_id` を更新
4. 全参加者の画面に新しい生体が表示される
5. WebSocketで `LaneChanged` イベント送信
```

---

### 4.4 管理者による進行制御

**手動進行**
- 落札が決まらない場合、管理者が手動で次へ進める
- 「次へ」ボタンをクリック
- その生体は `unsold` ステータスに

**一時停止**
- トラブル時に全レーンを一時停止
- 入札は受け付けない
- 価格も上昇しない

**再開**
- 一時停止を解除
- 入札再開

---

## 5. 落札後フロー

### 5.1 落札直後（自動処理）

**タイミング**: 落札確定時

1. 落札者に落札通知送信
2. 請求書データ生成

**システム処理**
- `won_items` レコード作成
- メール送信

**落札通知**
```
【落札おめでとうございます】
生体番号: 001
品種: 幹之メダカ
匹数: 5匹
落札価格: 1,200円/匹
合計金額: 6,000円

お支払い期限: 翌日まで
振込先: ...
```

---

### 5.2 落札商品確認（参加者）

**タイミング**: オークション終了後

1. 参加者が「落札管理」画面にアクセス
2. 落札した生体の一覧を確認
3. 合計金額を確認
4. 配送先住所を確認・編集（入金前のみ）

---

### 5.3 振込（参加者）

**タイミング**: 翌日まで（期限）

1. 参加者が指定口座に振込
2. 管理者が「落札者管理」画面で確認
3. 入金確認チェックを実行

**システム処理**
- `won_items.payment_status` を `paid` に更新
- `won_items.payment_confirmed_at` に日時記録
- 参加者に入金確認メール送信

---

### 5.4 商品発送（管理者）

**タイミング**: 入金確認後、翌日まで

1. 梱包作業
2. 配送業者に引き渡し
3. 追跡番号を記録

**システム処理**
- `won_items.delivery_status` を `shipped` に更新
- `won_items.shipped_at` に日時記録
- `won_items.tracking_number` に追跡番号記録
- 参加者に発送通知メール送信

**発送通知**
```
【商品発送のお知らせ】
生体番号: 001
品種: 幹之メダカ

お客様の商品を発送いたしました。
追跡番号: 1234567890
配送業者: ヤマト運輸

お問い合わせ番号で配送状況を確認できます。
```

---

## 6. システム設定フロー

### 6.1 システム設定変更（管理者）

**タイミング**: 必要に応じて

1. 管理者が「設定」画面にアクセス
2. 各種設定を変更
   - 価格上昇率（デフォルト: 10%）
   - 価格上昇の最低金額（デフォルト: 50円）
   - カウントダウン秒数（デフォルト: 3秒）
   - プレミアムプラン料金（デフォルト: 300円）
3. 保存ボタンをクリック

**システム処理**
- `system_settings` テーブルを更新
- 設定値をキャッシュ

---

## 7. トラブル対応フロー

### 7.1 オークション緊急停止

**トリガー**
- システム障害
- ネットワーク障害
- その他緊急事態

**フロー**
1. 管理者が緊急停止ボタンを押す
2. 全レーンが一時停止
3. 参加者に通知
4. 復旧後に再開

**システム処理**
- `lanes.status` を `paused` に更新
- WebSocket切断
- 一時停止通知送信

---

### 7.2 入金遅延

**フロー**
1. 期限内に入金がない場合
2. 管理者が落札者に連絡
3. 延長 or キャンセル判断

**キャンセルの場合**
- `won_items` を削除
- 次点の入札者に連絡（オプション）

---

## 8. 通知一覧

| 通知種別 | タイミング | 対象 | 送信方法 |
|---------|-----------|------|---------|
| 登録申請受付 | 登録申請時 | 参加者 | メール |
| 承認完了 | 承認時 | 参加者 | メール |
| お知らせ配信 | お知らせ公開時 | 全参加者 | メール（オプション） |
| オークション開催通知 | 前日17時 | 全参加者 | メール |
| 落札通知 | 落札時 | 参加者 | メール |
| 入金確認 | 入金確認時 | 参加者 | メール |
| 発送通知 | 発送時 | 参加者 | メール |

---

## 9. データフロー図

```
[参加者] --登録申請--> [users: pending]
                          ↓
        [管理者] --承認--> [users: approved]
                          ↓
                   [ログイン可能]
                          ↓
[管理者] --生体登録--> [items: registered]
                          ↓
        [管理者] --レーン割り当て--> [lane_items]
                          ↓
        [管理者] --開始--> [auctions: live]
                          ↓
[参加者] --入札ON--> [bids: is_active=true]
                          ↓
              [3秒ごとに価格上昇]
                          ↓
        [最後の1人] --> [won_items作成]
                          ↓
[参加者] --振込--> [won_items: payment_status=paid]
                          ↓
        [管理者] --発送--> [won_items: delivery_status=shipped]
```
