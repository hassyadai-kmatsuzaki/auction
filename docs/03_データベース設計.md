# メダカライブオークションシステム - データベース設計

## ER図概要

```
users (ユーザー)
  ├── bids (入札)
  └── won_items (落札)

auctions (オークションイベント)
  ├── items (生体/商品)
  └── lanes (レーン)
      └── lane_items (レーン商品)

items (生体/商品)
  ├── bids (入札)
  ├── won_items (落札)
  └── media (メディアファイル)

announcements (お知らせ)
```

---

## テーブル定義

### 1. users（ユーザー）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | ユーザーID |
| name | VARCHAR(255) | NO | | ユーザー名 |
| email | VARCHAR(255) | NO | UNQ | メールアドレス |
| email_verified_at | TIMESTAMP | YES | | メール認証日時 |
| password | VARCHAR(255) | NO | | パスワード（ハッシュ化） |
| user_type | ENUM('admin','participant') | NO | | ユーザー種別 |
| phone | VARCHAR(20) | YES | | 電話番号 |
| postal_code | VARCHAR(10) | YES | | 郵便番号 |
| address | TEXT | YES | | 住所 |
| status | ENUM('pending','approved','suspended') | NO | | ステータス |
| approved_at | TIMESTAMP | YES | | 承認日時 |
| approved_by | BIGINT UNSIGNED | YES | FK | 承認者ID |
| is_active | BOOLEAN | NO | | アカウント有効フラグ |
| remember_token | VARCHAR(100) | YES | | ログイン維持トークン |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**ユーザー種別**
- `admin`: 管理者
- `participant`: 参加者（入札者）

**ステータス**
- `pending`: 承認待ち
- `approved`: 承認済み
- `suspended`: 停止中

**インデックス**
- PRIMARY KEY (id)
- UNIQUE (email)
- INDEX (user_type)
- INDEX (status)
- FOREIGN KEY (approved_by) REFERENCES users(id)

---

### 2. auctions（オークションイベント）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | オークションID |
| title | VARCHAR(255) | NO | | オークション名 |
| event_date | DATE | NO | | 開催日 |
| start_time | TIME | NO | | 開始時刻 |
| status | ENUM('preparing','live','finished','cancelled') | NO | | ステータス |
| description | TEXT | YES | | 説明 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**ステータス**
- `preparing`: 準備中（編集可能）
- `live`: 開催中
- `finished`: 終了（編集・削除不可）
- `cancelled`: キャンセル

**インデックス**
- PRIMARY KEY (id)
- INDEX (event_date)
- INDEX (status)

---

### 3. items（生体/商品）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | 生体ID |
| auction_id | BIGINT UNSIGNED | NO | FK | オークションID |
| item_number | INT | NO | | 生体番号（オークション内） |
| species_name | VARCHAR(255) | NO | | 品種名 |
| quantity | INT | NO | | 匹数 |
| start_price | DECIMAL(10,2) | NO | | 開始価格（1匹あたり） |
| current_price | DECIMAL(10,2) | NO | | 現在価格（1匹あたり） |
| estimated_price | DECIMAL(10,2) | YES | | 落札想定金額 |
| inspection_info | TEXT | YES | | 審査情報 |
| individual_info | TEXT | YES | | 個体情報 |
| notes | TEXT | YES | | 備考 |
| is_premium | BOOLEAN | NO | | プレミアムプランフラグ |
| premium_fee | DECIMAL(10,2) | YES | | プレミアムプラン料金 |
| thumbnail_path | VARCHAR(255) | YES | | サムネイル画像パス |
| status | ENUM('registered','live','sold','unsold','cancelled') | NO | | ステータス |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**ステータス**
- `registered`: 登録済み（オークション前）
- `live`: オークション中
- `sold`: 落札済み
- `unsold`: 未落札
- `cancelled`: キャンセル

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (auction_id) REFERENCES auctions(id) ON DELETE CASCADE
- INDEX (auction_id, item_number)
- INDEX (status)

---

### 4. item_media（生体メディア）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | メディアID |
| item_id | BIGINT UNSIGNED | NO | FK | 生体ID |
| media_type | ENUM('video_top','video_side','photo') | NO | | メディア種別 |
| file_path | VARCHAR(255) | NO | | ファイルパス |
| file_size | INT | YES | | ファイルサイズ（バイト） |
| duration | INT | YES | | 再生時間（秒） |
| display_order | INT | NO | | 表示順序 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**メディア種別**
- `video_top`: 上見動画
- `video_side`: 横見動画
- `photo`: 写真（プレミアムプラン）

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
- INDEX (item_id, display_order)

---

### 5. lanes（レーン）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | レーンID |
| auction_id | BIGINT UNSIGNED | NO | FK | オークションID |
| lane_number | INT | NO | | レーン番号（1-6） |
| current_item_id | BIGINT UNSIGNED | YES | FK | 現在の生体ID |
| status | ENUM('waiting','active','paused','finished') | NO | | ステータス |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**ステータス**
- `waiting`: 待機中
- `active`: 進行中
- `paused`: 一時停止
- `finished`: 終了

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (auction_id) REFERENCES auctions(id) ON DELETE CASCADE
- FOREIGN KEY (current_item_id) REFERENCES items(id)
- UNIQUE (auction_id, lane_number)

---

### 6. lane_items（レーン商品割り当て）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | ID |
| lane_id | BIGINT UNSIGNED | NO | FK | レーンID |
| item_id | BIGINT UNSIGNED | NO | FK | 生体ID |
| sequence_order | INT | NO | | レーン内順序 |
| started_at | TIMESTAMP | YES | | 開始日時 |
| finished_at | TIMESTAMP | YES | | 終了日時 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (lane_id) REFERENCES lanes(id) ON DELETE CASCADE
- FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
- UNIQUE (lane_id, item_id)
- INDEX (lane_id, sequence_order)

---

### 7. bids（入札）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | 入札ID |
| item_id | BIGINT UNSIGNED | NO | FK | 生体ID |
| bidder_id | BIGINT UNSIGNED | NO | FK | 入札者ID |
| bid_price | DECIMAL(10,2) | NO | | 入札価格（1匹あたり） |
| is_active | BOOLEAN | NO | | アクティブフラグ（ON/OFF） |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
- FOREIGN KEY (bidder_id) REFERENCES users(id) ON DELETE CASCADE
- INDEX (item_id, is_active)
- INDEX (bidder_id)

---

### 8. won_items（落札）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | 落札ID |
| item_id | BIGINT UNSIGNED | NO | FK | 生体ID |
| winner_id | BIGINT UNSIGNED | NO | FK | 落札者ID |
| winning_price | DECIMAL(10,2) | NO | | 落札価格（1匹あたり） |
| total_amount | DECIMAL(10,2) | NO | | 合計金額 |
| payment_status | ENUM('pending','paid','refunded') | NO | | 支払いステータス |
| payment_confirmed_at | TIMESTAMP | YES | | 入金確認日時 |
| delivery_status | ENUM('pending','shipped','completed') | NO | | 発送ステータス |
| shipping_address | TEXT | YES | | 配送先住所 |
| shipped_at | TIMESTAMP | YES | | 発送日時 |
| tracking_number | VARCHAR(100) | YES | | 追跡番号 |
| notes | TEXT | YES | | 備考 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**支払いステータス**
- `pending`: 支払い待ち
- `paid`: 支払い済み
- `refunded`: 返金済み

**発送ステータス**
- `pending`: 発送待ち
- `shipped`: 発送済み
- `completed`: 完了

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
- FOREIGN KEY (winner_id) REFERENCES users(id) ON DELETE CASCADE
- UNIQUE (item_id)
- INDEX (winner_id)
- INDEX (payment_status)

---

### 9. announcements（お知らせ）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | お知らせID |
| title | VARCHAR(255) | NO | | タイトル |
| content | TEXT | NO | | 本文 |
| is_published | BOOLEAN | NO | | 公開フラグ |
| published_at | TIMESTAMP | YES | | 公開日時 |
| expires_at | TIMESTAMP | YES | | 有効期限 |
| priority | ENUM('low','normal','high') | NO | | 優先度 |
| created_by | BIGINT UNSIGNED | NO | FK | 作成者ID |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**優先度**
- `low`: 低
- `normal`: 通常
- `high`: 高（重要）

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (created_by) REFERENCES users(id)
- INDEX (is_published, published_at)

---

### 10. announcement_reads（お知らせ既読管理）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | ID |
| announcement_id | BIGINT UNSIGNED | NO | FK | お知らせID |
| user_id | BIGINT UNSIGNED | NO | FK | ユーザーID |
| read_at | TIMESTAMP | NO | | 既読日時 |
| created_at | TIMESTAMP | NO | | 作成日時 |

**インデックス**
- PRIMARY KEY (id)
- FOREIGN KEY (announcement_id) REFERENCES announcements(id) ON DELETE CASCADE
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- UNIQUE (announcement_id, user_id)

---

### 11. system_settings（システム設定）

| カラム名 | 型 | NULL | キー | 説明 |
|---------|---|------|------|------|
| id | BIGINT UNSIGNED | NO | PK | 設定ID |
| key | VARCHAR(255) | NO | UNQ | 設定キー |
| value | TEXT | NO | | 設定値 |
| description | TEXT | YES | | 説明 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

**設定キーの例**
- `site_name`: サイト名
- `contact_email`: 連絡先メールアドレス
- `price_increment_rate`: 価格上昇率（%）
- `price_increment_min`: 価格上昇の最低金額
- `countdown_seconds`: カウントダウン秒数
- `premium_plan_fee`: プレミアムプラン料金

**インデックス**
- PRIMARY KEY (id)
- UNIQUE (key)

---

## リレーション図

```
users (1) ──< (N) bids
users (1) ──< (N) won_items
users (1) ──< (N) announcements (created_by)

auctions (1) ──< (N) items
auctions (1) ──< (N) lanes

items (1) ──< (N) item_media
items (1) ──< (N) bids
items (1) ──< (1) won_items
items (1) ──< (N) lane_items

lanes (1) ──< (N) lane_items

announcements (1) ──< (N) announcement_reads
```

---

## インデックス戦略

### パフォーマンス重視のインデックス

1. **リアルタイム入札用**
   - `bids`: (item_id, is_active, created_at)
   - `items`: (auction_id, status, item_number)

2. **レーン進行用**
   - `lane_items`: (lane_id, sequence_order)
   - `lanes`: (auction_id, lane_number)

3. **落札管理用**
   - `won_items`: (winner_id, payment_status)
   - `won_items`: (item_id) UNIQUE

4. **ユーザー承認用**
   - `users`: (status, created_at)

---

## 削除されたテーブル（前バージョンから）

以下のテーブルは削除されました：

- ❌ `listings` → `items`に統合（出品者概念の削除）
- ❌ `favorites` → お気に入り機能削除
- ❌ `deposits` → 保証金システム削除
- ❌ `payments` → 簡素化（出品者への支払い不要）
- ❌ `notifications` → `announcements`に集約
