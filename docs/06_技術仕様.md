# メダカライブオークションシステム - 技術仕様

## 技術スタック詳細

### フロントエンド

#### コア技術
- **TypeScript** 5.6.3
- **React** 18.3.1
- **Material-UI (MUI)** 6.1.7
  - `@mui/material`
  - `@mui/icons-material`
  - `@emotion/react`
  - `@emotion/styled`

#### ビルドツール
- **Vite** 7.0.7
- **Laravel Vite Plugin** 2.0.0

#### 状態管理（検討中）
- React Context API
- または Zustand（推奨）

#### リアルタイム通信
- **Laravel Echo** + **Pusher** または **Socket.io**
- WebSocket接続

---

### バックエンド

#### コア技術
- **PHP** 8.2+
- **Laravel** 11.x
- **Composer** 2.x

#### 認証
- **Laravel Sanctum**
  - SPA認証
  - APIトークン管理

#### リアルタイム
- **Laravel Broadcasting**
- **Laravel Echo Server** または **Pusher**
- **Redis** (キュー・セッション管理)

#### ファイルストレージ
- **Laravel Storage**
- S3互換ストレージ（本番環境）

---

### データベース

#### RDBMS
- **MySQL** 8.0+
- 文字コード: `utf8mb4`
- 照合順序: `utf8mb4_unicode_ci`

#### キャッシュ
- **Redis** 7.x
  - セッション管理
  - キャッシュ
  - キュー
  - リアルタイム通信のPub/Sub

---

### インフラ

#### 開発環境
- **Docker** 24.x
- **Docker Compose** 3.9

#### コンテナ構成
```yaml
auction-proxy   (Nginx)
auction-app     (PHP-FPM + Laravel)
auction-db      (MySQL)
auction-redis   (Redis) ※追加予定
```

#### 本番環境（検討中）
- AWS EC2 / ECS
- AWS RDS (MySQL)
- AWS ElastiCache (Redis)
- AWS S3 (ファイルストレージ)
- CloudFront (CDN)

---

## ディレクトリ構成

### フロントエンド

```
src/resources/
├── ts/
│   ├── main.tsx                 # エントリーポイント
│   ├── App.tsx                  # ルートコンポーネント
│   ├── theme.ts                 # MUIテーマ設定
│   ├── vite-env.d.ts           # Vite型定義
│   │
│   ├── components/              # 共通コンポーネント
│   │   ├── common/
│   │   │   ├── Header.tsx
│   │   │   ├── Footer.tsx
│   │   │   ├── Loading.tsx
│   │   │   └── ErrorBoundary.tsx
│   │   ├── auction/
│   │   │   ├── LiveLane.tsx    # レーン1つ分
│   │   │   ├── BidButton.tsx   # ON/OFFボタン
│   │   │   ├── PriceDisplay.tsx
│   │   │   └── CountdownTimer.tsx
│   │   ├── item/
│   │   │   ├── ItemCard.tsx
│   │   │   ├── ItemDetail.tsx
│   │   │   └── MediaGallery.tsx
│   │   └── announcement/
│   │       └── AnnouncementCard.tsx
│   │
│   ├── pages/                   # ページコンポーネント
│   │   ├── auth/
│   │   │   ├── Login.tsx
│   │   │   └── Register.tsx
│   │   ├── participant/
│   │   │   ├── Home.tsx         # お知らせ一覧
│   │   │   ├── AuctionLive.tsx # オークション会場
│   │   │   └── WonItems.tsx    # 落札管理
│   │   └── admin/
│   │       ├── Dashboard.tsx
│   │       ├── AnnouncementManagement.tsx
│   │       ├── AuctionManagement.tsx
│   │       ├── ItemManagement.tsx
│   │       ├── LiveControl.tsx
│   │       ├── WonItemManagement.tsx
│   │       ├── UserManagement.tsx
│   │       └── Settings.tsx
│   │
│   ├── hooks/                   # カスタムフック
│   │   ├── useAuth.ts
│   │   ├── useWebSocket.ts
│   │   ├── useLiveAuction.ts
│   │   └── useAnnouncements.ts
│   │
│   ├── services/                # API通信
│   │   ├── api.ts              # Axios設定
│   │   ├── authService.ts
│   │   ├── auctionService.ts
│   │   ├── itemService.ts
│   │   ├── bidService.ts
│   │   └── announcementService.ts
│   │
│   ├── types/                   # TypeScript型定義
│   │   ├── user.ts
│   │   ├── auction.ts
│   │   ├── item.ts
│   │   ├── bid.ts
│   │   ├── wonItem.ts
│   │   └── announcement.ts
│   │
│   └── utils/                   # ユーティリティ
│       ├── format.ts           # 日付・金額フォーマット
│       ├── validation.ts
│       └── constants.ts
│
└── css/
    └── app.css                  # Tailwind CSS
```

---

### バックエンド

```
src/
├── app/
│   ├── Http/
│   │   ├── Controllers/
│   │   │   ├── Auth/
│   │   │   │   ├── LoginController.php
│   │   │   │   └── RegisterController.php
│   │   │   ├── Api/
│   │   │   │   ├── AnnouncementController.php
│   │   │   │   ├── AuctionController.php
│   │   │   │   ├── ItemController.php
│   │   │   │   ├── BidController.php
│   │   │   │   └── WonItemController.php
│   │   │   └── Admin/
│   │   │       ├── AnnouncementManagementController.php
│   │   │       ├── AuctionManagementController.php
│   │   │       ├── ItemManagementController.php
│   │   │       ├── LiveControlController.php
│   │   │       ├── WonItemManagementController.php
│   │   │       ├── UserController.php
│   │   │       └── SettingsController.php
│   │   │
│   │   ├── Middleware/
│   │   │   ├── CheckUserType.php
│   │   │   ├── CheckUserApproved.php
│   │   │   └── CheckAuctionEditable.php
│   │   │
│   │   ├── Requests/
│   │   │   ├── Auth/
│   │   │   ├── Auction/
│   │   │   ├── Item/
│   │   │   ├── Bid/
│   │   │   └── Announcement/
│   │   │
│   │   └── Resources/
│   │       ├── AuctionResource.php
│   │       ├── ItemResource.php
│   │       ├── BidResource.php
│   │       ├── WonItemResource.php
│   │       ├── UserResource.php
│   │       └── AnnouncementResource.php
│   │
│   ├── Models/
│   │   ├── User.php
│   │   ├── Auction.php
│   │   ├── Item.php
│   │   ├── ItemMedia.php
│   │   ├── Lane.php
│   │   ├── LaneItem.php
│   │   ├── Bid.php
│   │   ├── WonItem.php
│   │   ├── Announcement.php
│   │   ├── AnnouncementRead.php
│   │   └── SystemSetting.php
│   │
│   ├── Services/
│   │   ├── AuctionService.php      # オークション管理
│   │   ├── BidService.php          # 入札ロジック
│   │   ├── PriceCalculationService.php  # 価格上昇計算
│   │   ├── LaneProgressService.php # レーン進行管理
│   │   ├── NotificationService.php # 通知送信
│   │   └── MediaUploadService.php  # メディアアップロード
│   │
│   ├── Events/
│   │   ├── PriceUpdated.php        # 価格更新イベント
│   │   ├── LaneChanged.php         # レーン切替イベント
│   │   ├── BidderJoined.php        # 入札者参加イベント
│   │   └── BidderLeft.php          # 入札者離脱イベント
│   │
│   ├── Listeners/
│   │   ├── SendPriceUpdateNotification.php
│   │   └── UpdateLaneStatus.php
│   │
│   ├── Jobs/
│   │   ├── ProcessBidIncrement.php # 価格上昇処理（非同期）
│   │   ├── SendNotification.php    # 通知送信（非同期）
│   │   └── GenerateInvoice.php     # 請求書生成
│   │
│   └── Console/
│       └── Commands/
│           ├── StartAuction.php    # オークション開始コマンド
│           └── CleanupOldAuctions.php
│
├── database/
│   ├── migrations/
│   │   ├── 2024_01_01_create_users_table.php
│   │   ├── 2024_01_02_create_auctions_table.php
│   │   ├── 2024_01_03_create_items_table.php
│   │   ├── 2024_01_04_create_item_media_table.php
│   │   ├── 2024_01_05_create_lanes_table.php
│   │   ├── 2024_01_06_create_lane_items_table.php
│   │   ├── 2024_01_07_create_bids_table.php
│   │   ├── 2024_01_08_create_won_items_table.php
│   │   ├── 2024_01_09_create_announcements_table.php
│   │   ├── 2024_01_10_create_announcement_reads_table.php
│   │   └── 2024_01_11_create_system_settings_table.php
│   │
│   ├── seeders/
│   │   ├── DatabaseSeeder.php
│   │   ├── UserSeeder.php
│   │   ├── AuctionSeeder.php
│   │   ├── ItemSeeder.php
│   │   └── SystemSettingSeeder.php
│   │
│   └── factories/
│       ├── UserFactory.php
│       ├── AuctionFactory.php
│       └── ItemFactory.php
│
├── routes/
│   ├── api.php                     # APIルート
│   ├── web.php                     # Webルート
│   └── channels.php                # Broadcasting設定
│
└── config/
    ├── broadcasting.php
    ├── filesystems.php
    └── sanctum.php
```

---

## リアルタイム入札の実装

### WebSocket接続

#### フロントエンド
```typescript
// useLiveAuction.ts
import Echo from 'laravel-echo';
import Pusher from 'pusher-js';

window.Pusher = Pusher;

const echo = new Echo({
  broadcaster: 'pusher',
  key: import.meta.env.VITE_PUSHER_APP_KEY,
  cluster: import.meta.env.VITE_PUSHER_APP_CLUSTER,
  wsHost: import.meta.env.VITE_PUSHER_HOST,
  wsPort: import.meta.env.VITE_PUSHER_PORT,
  forceTLS: false,
  disableStats: true,
});

export const useLiveAuction = (auctionId: number) => {
  useEffect(() => {
    // チャンネル購読
    echo.channel(`auction.${auctionId}.live`)
      .listen('PriceUpdated', (e) => {
        // 価格更新処理
        updatePrice(e.item_id, e.new_price);
      })
      .listen('LaneChanged', (e) => {
        // レーン切替処理
        changeLane(e.lane_id, e.current_item_id);
      })
      .listen('BidderJoined', (e) => {
        // 入札者参加
        updateBidderCount(e.item_id, e.active_bidders_count);
      })
      .listen('BidderLeft', (e) => {
        // 入札者離脱
        updateBidderCount(e.item_id, e.active_bidders_count);
      });

    return () => {
      echo.leaveChannel(`auction.${auctionId}.live`);
    };
  }, [auctionId]);
};
```

#### バックエンド
```php
// BidService.php
use App\Events\PriceUpdated;
use App\Events\BidderJoined;

public function toggleBid(Item $item, User $user, bool $isActive)
{
    $bid = Bid::updateOrCreate(
        ['item_id' => $item->id, 'bidder_id' => $user->id],
        ['is_active' => $isActive, 'bid_price' => $item->current_price]
    );

    $activeBiddersCount = $item->bids()
        ->where('is_active', true)
        ->count();

    // WebSocketでブロードキャスト
    if ($isActive) {
        broadcast(new BidderJoined($item, $activeBiddersCount))->toOthers();
    } else {
        broadcast(new BidderLeft($item, $activeBiddersCount))->toOthers();
    }

    // 価格上昇チェック
    if ($activeBiddersCount > 1) {
        $this->schedulePriceIncrement($item);
    }
}

private function schedulePriceIncrement(Item $item)
{
    // 3秒後に価格上昇ジョブをディスパッチ
    ProcessBidIncrement::dispatch($item)->delay(now()->addSeconds(3));
}
```

---

### 価格上昇ロジック

```php
// PriceCalculationService.php
namespace App\Services;

class PriceCalculationService
{
    /**
     * 価格上昇額を計算
     */
    public function calculateIncrement(float $currentPrice): float
    {
        $rate = SystemSetting::get('price_increment_rate', 10); // デフォルト10%
        $min = SystemSetting::get('price_increment_min', 50);   // デフォルト50円
        
        return max($currentPrice * ($rate / 100), $min);
    }

    /**
     * 次の価格を計算
     */
    public function calculateNextPrice(float $currentPrice): float
    {
        $increment = $this->calculateIncrement($currentPrice);
        return round($currentPrice + $increment, -1); // 10円単位で四捨五入
    }
}
```

```php
// ProcessBidIncrement.php (Job)
namespace App\Jobs;

use App\Models\Item;
use App\Services\PriceCalculationService;
use App\Events\PriceUpdated;

class ProcessBidIncrement implements ShouldQueue
{
    public function __construct(public Item $item) {}

    public function handle(PriceCalculationService $priceService)
    {
        // 現在のアクティブ入札者数を確認
        $activeBiddersCount = $this->item->bids()
            ->where('is_active', true)
            ->count();

        if ($activeBiddersCount > 1) {
            // 複数人入札中 → 価格上昇
            $newPrice = $priceService->calculateNextPrice($this->item->current_price);
            
            $this->item->update(['current_price' => $newPrice]);

            // WebSocketでブロードキャスト
            broadcast(new PriceUpdated($this->item, $activeBiddersCount));

            // 次の価格上昇をスケジュール
            self::dispatch($this->item)->delay(now()->addSeconds(3));
        }
    }
}
```

---

### 入札タイマー

```typescript
// CountdownTimer.tsx
import React, { useEffect, useState } from 'react';
import { Typography } from '@mui/material';

interface Props {
  itemId: number;
  activeBiddersCount: number;
  onTimeout: () => void;
}

export const CountdownTimer: React.FC<Props> = ({
  itemId,
  activeBiddersCount,
  onTimeout,
}) => {
  const [seconds, setSeconds] = useState(3);

  useEffect(() => {
    if (activeBiddersCount <= 1) {
      // 1人以下ならカウント停止
      setSeconds(3);
      return;
    }

    const timer = setInterval(() => {
      setSeconds((prev) => {
        if (prev <= 1) {
          onTimeout();
          return 3; // リセット
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [activeBiddersCount, onTimeout]);

  if (activeBiddersCount <= 1) {
    return null; // 1人以下の場合は表示しない
  }

  return (
    <Typography 
      variant="h6" 
      color={seconds <= 1 ? 'error' : 'primary'}
      sx={{ fontWeight: 'bold' }}
    >
      {seconds}秒
    </Typography>
  );
};
```

---

## パフォーマンス最適化

### データベース最適化

#### インデックス
```sql
-- リアルタイム入札用
CREATE INDEX idx_bids_item_active ON bids(item_id, is_active, created_at);

-- レーン進行用
CREATE INDEX idx_lane_items_sequence ON lane_items(lane_id, sequence_order);

-- ユーザー承認用
CREATE INDEX idx_users_status ON users(status, created_at);
```

#### クエリキャッシュ
```php
// Redisキャッシュの活用
$activeBidders = Cache::remember(
    "item.{$itemId}.active_bidders",
    5, // 5秒
    fn() => $item->bids()->where('is_active', true)->count()
);
```

---

### フロントエンド最適化

#### コード分割
```typescript
// React.lazy でページごとに分割
const AuctionLive = lazy(() => import('./pages/participant/AuctionLive'));
const AdminDashboard = lazy(() => import('./pages/admin/Dashboard'));
```

#### 画像最適化
- 動画はサムネイル生成
- 画像は複数サイズ（thumbnail/medium/large）
- Lazy Loading実装

---

## セキュリティ

### 認証・認可
- Laravel Sanctum によるトークン認証
- ミドルウェアでユーザー種別チェック
- 承認済みユーザーのみログイン可能
- CSRFトークン検証

### データ検証
- FormRequestで入力値バリデーション
- XSS対策（エスケープ処理）
- SQLインジェクション対策（Eloquent ORM）

### レート制限
```php
// routes/api.php
Route::middleware(['auth:sanctum', 'throttle:60,1'])->group(function () {
    // 1分間に60リクエストまで
});
```

---

## テスト戦略

### ユニットテスト
- PHPUnit
- サービスクラスのロジックテスト
- 価格計算ロジックのテスト

### 機能テスト
- Laravel Feature Tests
- APIエンドポイントのテスト
- ユーザー承認フローのテスト

### E2Eテスト（検討中）
- Playwright または Cypress
- オークション会場のテスト

---

## デプロイ

### 環境変数
```env
APP_NAME="メダカライブオークション"
APP_ENV=production
APP_DEBUG=false

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=auction
DB_USERNAME=admin
DB_PASSWORD=xxxxx

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

BROADCAST_DRIVER=pusher
CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis

PUSHER_APP_ID=xxxxx
PUSHER_APP_KEY=xxxxx
PUSHER_APP_SECRET=xxxxx
PUSHER_APP_CLUSTER=ap3

MAIL_MAILER=smtp
MAIL_HOST=smtp.example.com
```

### ビルドコマンド
```bash
# フロントエンド
npm run build

# バックエンド
composer install --optimize-autoloader --no-dev
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan migrate --force
```
