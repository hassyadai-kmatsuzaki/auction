# データベースマイグレーション実行ガイド

## 📋 目次

1. [マイグレーション概要](#マイグレーション概要)
2. [事前準備](#事前準備)
3. [マイグレーション実行](#マイグレーション実行)
4. [マイグレーションファイル一覧](#マイグレーションファイル一覧)
5. [トラブルシューティング](#トラブルシューティング)

---

## マイグレーション概要

メダカライブオークションシステムでは、**全14テーブル**を作成します。

### テーブル構成

| # | テーブル名 | 説明 | 依存関係 |
|---|----------|------|---------|
| 1 | users | ユーザー（管理者・参加者） | なし |
| 2 | sellers | 出品者情報 | なし |
| 3 | auctions | オークションイベント | users |
| 4 | auction_deposits | オークション別保証金設定 | auctions |
| 5 | deposits | 参加者保証金管理 | auctions, users |
| 6 | items | 生体/商品 | auctions, sellers |
| 7 | item_media | 生体メディア（画像・動画） | items |
| 8 | lanes | レーン | auctions, items |
| 9 | lane_items | レーン商品割り当て | lanes, items |
| 10 | bids | 入札 | items, users |
| 11 | won_items | 落札 | items, users |
| 12 | announcements | お知らせ | users, auctions |
| 13 | announcement_reads | お知らせ既読管理 | announcements, users |
| 14 | system_settings | システム設定 | なし |

---

## 事前準備

### 1. データベース接続確認

`.env`ファイルでデータベース接続情報を確認します。

```bash
DB_CONNECTION=mysql
DB_HOST=db
DB_PORT=3306
DB_DATABASE=medaka_auction
DB_USERNAME=root
DB_PASSWORD=root
```

### 2. Dockerコンテナの起動

```bash
cd /Users/koheimatsuzaki/Desktop/auction
docker-compose up -d
```

### 3. データベース接続テスト

```bash
docker exec -it auction-app php artisan tinker
```

Tinker内で以下を実行：

```php
DB::connection()->getPdo();
// PDO オブジェクトが返ってくればOK
exit
```

---

## マイグレーション実行

### 方法1: コンテナ内で実行（推奨）

```bash
# コンテナに入る
docker exec -it auction-app bash

# マイグレーション実行
cd /var/www/html
php artisan migrate

# 実行確認
php artisan migrate:status
```

### 方法2: ホストから直接実行

```bash
docker exec -it auction-app php artisan migrate
```

### マイグレーション実行結果

正常に実行されると、以下のような出力が表示されます：

```
   INFO  Preparing database.

  Creating migration table .................................. 10ms DONE

   INFO  Running migrations.

  2024_01_16_000001_update_users_table_for_auction ....... 25ms DONE
  2024_01_16_000002_create_sellers_table ................. 18ms DONE
  2024_01_16_000003_create_auctions_table ................ 22ms DONE
  2024_01_16_000004_create_auction_deposits_table ........ 15ms DONE
  2024_01_16_000005_create_deposits_table ................ 20ms DONE
  2024_01_16_000006_create_items_table ................... 28ms DONE
  2024_01_16_000007_create_item_media_table .............. 18ms DONE
  2024_01_16_000008_create_lanes_table ................... 20ms DONE
  2024_01_16_000009_create_lane_items_table .............. 17ms DONE
  2024_01_16_000010_create_bids_table .................... 22ms DONE
  2024_01_16_000011_create_won_items_table ............... 30ms DONE
  2024_01_16_000012_create_announcements_table ........... 20ms DONE
  2024_01_16_000013_create_announcement_reads_table ...... 15ms DONE
  2024_01_16_000014_create_system_settings_table ......... 18ms DONE
```

---

## マイグレーションファイル一覧

### Phase 1: 基盤テーブル

#### 1. usersテーブル拡張

**ファイル**: `2024_01_16_000001_update_users_table_for_auction.php`

**追加カラム**:
- `user_type`: ユーザー種別（admin/participant）
- `phone`, `postal_code`, `prefecture`, `city`, `address_line1`, `address_line2`: 連絡先情報
- `status`: 承認ステータス（pending/approved/suspended/rejected）
- `approved_at`, `approved_by`, `rejected_reason`: 承認管理
- `last_login_at`: 最終ログイン
- `is_active`: アカウント有効フラグ
- `deleted_at`: 論理削除

#### 2. sellersテーブル

**ファイル**: `2024_01_16_000002_create_sellers_table.php`

**主要カラム**:
- 出品者基本情報（コード、名前、連絡先）
- 銀行口座情報（振込先）
- 手数料率設定

### Phase 2: オークション基本

#### 3. auctionsテーブル

**ファイル**: `2024_01_16_000003_create_auctions_table.php`

**主要カラム**:
- オークション基本情報（タイトル、開催日時）
- ステータス管理（preparing/scheduled/live/finished/cancelled）
- レーン数、入札単位、カウントダウン設定
- 期限設定（アップロード、入金、発送）

#### 4. auction_depositsテーブル

**ファイル**: `2024_01_16_000004_create_auction_deposits_table.php`

**主要カラム**:
- オークション別保証金額
- 保証金タイプ（none/fixed/flexible）

#### 5. depositsテーブル

**ファイル**: `2024_01_16_000005_create_deposits_table.php`

**主要カラム**:
- 参加者ごとの保証金管理
- 支払いステータス（pending/confirmed/refunded/forfeited）
- 返金情報

### Phase 3: 商品管理

#### 6. itemsテーブル

**ファイル**: `2024_01_16_000006_create_items_table.php`

**主要カラム**:
- 商品基本情報（品種名、匹数）
- 価格情報（開始価格、現在価格、入札単位）
- 商品情報（審査情報、個体情報、備考）
- プレミアムプラン設定
- ステータス管理
- 未落札時対応設定

#### 7. item_mediaテーブル

**ファイル**: `2024_01_16_000007_create_item_media_table.php`

**主要カラム**:
- メディアタイプ（video_top/video_side/photo_top/photo_side/photo_other）
- ファイル情報（パス、サイズ、MIMEタイプ）
- 動画情報（再生時間）
- 画像情報（幅、高さ）
- 表示順序

### Phase 4: レーン・入札

#### 8. lanesテーブル

**ファイル**: `2024_01_16_000008_create_lanes_table.php`

**主要カラム**:
- レーン番号（1-6）
- 現在の商品ID
- ステータス（waiting/active/paused/finished）
- 開始・終了日時

#### 9. lane_itemsテーブル

**ファイル**: `2024_01_16_000009_create_lane_items_table.php`

**主要カラム**:
- レーンと商品の紐付け
- レーン内順序
- 開始・終了日時
- 所要時間

#### 10. bidsテーブル

**ファイル**: `2024_01_16_000010_create_bids_table.php`

**主要カラム**:
- 入札価格（1匹あたり）
- 合計金額
- アクティブフラグ（ON/OFF）
- 入札タイプ（manual/auto）
- IPアドレス、ユーザーエージェント

### Phase 5: 落札・決済

#### 11. won_itemsテーブル

**ファイル**: `2024_01_16_000011_create_won_items_table.php`

**主要カラム**:
- 落札価格、合計金額
- 手数料計算（手数料率、手数料額、出品者受取額）
- 支払い情報（ステータス、方法、期限）
- 受取方法（配送/現地引取）
- 配送先情報
- 配送業者、追跡番号

### Phase 6: お知らせ

#### 12. announcementsテーブル

**ファイル**: `2024_01_16_000012_create_announcements_table.php`

**主要カラム**:
- タイトル、本文
- お知らせ種別（general/auction/system/maintenance）
- 対象者（all/participants/admins）
- 公開設定、有効期限
- 優先度（low/normal/high/urgent）

#### 13. announcement_readsテーブル

**ファイル**: `2024_01_16_000013_create_announcement_reads_table.php`

**主要カラム**:
- お知らせIDとユーザーIDの紐付け
- 既読日時

### Phase 7: システム設定

#### 14. system_settingsテーブル

**ファイル**: `2024_01_16_000014_create_system_settings_table.php`

**主要カラム**:
- 設定キー（一意）
- 設定値
- 値の型（string/integer/decimal/boolean/json）
- カテゴリ
- 表示名、説明
- 公開設定

**初期データ**:
- サイト設定（サイト名、連絡先）
- オークション設定（レーン数、カウントダウン、入札単位、価格上昇率）
- プレミアムプラン設定（料金、写真枚数）
- 支払い設定（入金期限、手数料率）
- 配送設定（発送期限、配送業者）

---

## マイグレーション管理コマンド

### ステータス確認

```bash
php artisan migrate:status
```

### ロールバック（最新バッチを戻す）

```bash
php artisan migrate:rollback
```

### ロールバック（全マイグレーションを戻す）

```bash
php artisan migrate:reset
```

### リフレッシュ（全ロールバック後に再実行）

```bash
php artisan migrate:refresh
```

### リフレッシュ + シーダー実行

```bash
php artisan migrate:refresh --seed
```

### フレッシュ（全テーブル削除後に再実行）

```bash
php artisan migrate:fresh
```

### フレッシュ + シーダー実行

```bash
php artisan migrate:fresh --seed
```

---

## トラブルシューティング

### エラー1: SQLSTATE[42S01]: Base table or view already exists

**原因**: テーブルが既に存在する

**解決方法**:
```bash
# ロールバックして再実行
php artisan migrate:rollback
php artisan migrate
```

または

```bash
# フレッシュ（全削除して再実行）
php artisan migrate:fresh
```

### エラー2: SQLSTATE[HY000]: General error: 1005 Can't create table

**原因**: 外部キー制約のエラー（参照先テーブルが存在しない）

**解決方法**:
- マイグレーションファイルの実行順序を確認
- ファイル名の日時部分で順序が正しいか確認

### エラー3: Access denied for user

**原因**: データベース接続情報が誤っている

**解決方法**:
```bash
# .envファイルを確認
cat .env | grep DB_

# 設定キャッシュをクリア
php artisan config:clear
php artisan cache:clear
```

### エラー4: Syntax error or access violation: 1071 Specified key was too long

**原因**: インデックスキーが長すぎる（古いMySQL）

**解決方法**:
`app/Providers/AppServiceProvider.php`の`boot`メソッドに追加：

```php
use Illuminate\Support\Facades\Schema;

public function boot()
{
    Schema::defaultStringLength(191);
}
```

### エラー5: Database connection refused

**原因**: MySQLコンテナが起動していない

**解決方法**:
```bash
# コンテナ状態を確認
docker-compose ps

# MySQLコンテナのログを確認
docker-compose logs db

# コンテナを再起動
docker-compose restart db

# 接続テスト
docker exec -it auction-app php artisan tinker
>>> DB::connection()->getPdo();
```

---

## データベース構造の確認

### テーブル一覧を表示

```bash
docker exec -it auction-app php artisan db:table
```

### 特定テーブルの構造を表示

```bash
docker exec -it auction-app php artisan db:show items
```

### 全テーブルの情報を表示

```bash
docker exec -it auction-app php artisan db:show --database
```

### MySQLに直接接続

```bash
docker exec -it auction-db mysql -uroot -proot medaka_auction
```

MySQL内で：

```sql
-- テーブル一覧
SHOW TABLES;

-- 特定テーブルの構造
DESCRIBE items;

-- テーブルのCREATE文を表示
SHOW CREATE TABLE items\G

-- 外部キー制約を確認
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    CONSTRAINT_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = 'medaka_auction'
AND REFERENCED_TABLE_NAME IS NOT NULL;
```

---

## 初期データ投入

### Seederの作成

```bash
php artisan make:seeder AdminUserSeeder
php artisan make:seeder SystemSettingsSeeder
```

### Seederの実行

```bash
# 全Seeder実行
php artisan db:seed

# 特定のSeeder実行
php artisan db:seed --class=AdminUserSeeder
```

### マイグレーション + Seeder

```bash
php artisan migrate:fresh --seed
```

---

## 本番環境へのマイグレーション

### 注意事項

⚠️ **本番環境では`migrate:fresh`や`migrate:refresh`を絶対に使用しないでください！**
（全データが削除されます）

### 推奨手順

```bash
# 1. バックアップ
php artisan backup:run  # または mysqldump

# 2. メンテナンスモード開始
php artisan down

# 3. マイグレーション実行
php artisan migrate --force

# 4. キャッシュクリア
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# 5. 動作確認

# 6. メンテナンスモード解除
php artisan up
```

---

## 完璧なデータベース構成 ✅

この14テーブル構成により、以下が実現できます：

✅ **完全なユーザー管理**（承認制、論理削除対応）  
✅ **出品者管理**（銀行口座、手数料率）  
✅ **柔軟なオークション設定**（レーン数、入札単位、期限）  
✅ **保証金管理**（オークション別設定、返金対応）  
✅ **詳細な商品管理**（プレミアムプラン、未落札時対応）  
✅ **マルチメディア対応**（動画・写真、表示順序）  
✅ **6レーン同時進行**（レーン割り当て、進行管理）  
✅ **リアルタイム入札**（ON/OFF、自動上昇）  
✅ **完全な落札管理**（支払い、配送、受取方法）  
✅ **お知らせ配信**（既読管理、優先度）  
✅ **柔軟なシステム設定**（DB管理、型安全）  

---

**メダカライブオークションシステムのデータベースが完璧に構築されました！** 🎉
